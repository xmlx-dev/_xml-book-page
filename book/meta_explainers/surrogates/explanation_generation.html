
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>1.3. Explanation Generation &#8212; eXplainable&lt;br&gt;Machine Learning</title>
    
  <link href="../../../_static/css/theme.css" rel="stylesheet">
  <link href="../../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/xmlx.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="canonical" href="https://book.xmlx.io/book/meta_explainers/surrogates/explanation_generation.html" />
    <link rel="shortcut icon" href="../../../_static/bulb.svg"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="1.4. Interactive Examples" href="examples.html" />
    <link rel="prev" title="1.2. Data Sampling" href="data_sampling.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-6635EH38S9"></script>
<script>
                    window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-6635EH38S9');
                </script>

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../../_static/bulb.svg" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">eXplainable<br>Machine Learning</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../README.html">
   eXplainable Machine Learning
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../preface/index.html">
   Preface
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../preface/glossary.html">
     Glossary
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../preface/preliminary.html">
     Preliminary Information
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../preface/data.html">
     Modules, Data Sets and Models
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../index.html">
   Meta-Explainers
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 current active has-children">
    <a class="reference internal" href="index.html">
     1. Surrogates
    </a>
    <input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
    <label for="toctree-checkbox-3">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul class="current">
     <li class="toctree-l3">
      <a class="reference internal" href="interpretable_representations.html">
       1.1. Binary Interpretable Representations for Tabular Data
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="data_sampling.html">
       1.2. Data Sampling
      </a>
     </li>
     <li class="toctree-l3 current active">
      <a class="current reference internal" href="#">
       1.3. Explanation Generation
      </a>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="examples.html">
       1.4. Interactive Examples
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
      <label for="toctree-checkbox-4">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="ex_tabular.html">
         1.4.1. Surrogate Explainer of Tabular Data
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="ex_ols.html">
         1.4.2. Investigating Linear Surrogate Explainers of Tabular Data
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../bibliography.html">
   Bibliography
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../genindex.html">
   Index
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://book.xmlx.io/docs/">
   XML Book Documentation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://xmlx.io/">
   XMLX Homepage
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  <a href="https://doi.org/XX.XXXX/zenodo.XXXXXXX"><img src="https://zenodo.org/badge/DOI/XX.XXXX/zenodo.XXXXXXX.svg" alt="DOI"></a>

</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        <a class="dropdown-buttons"
            href="../../../_sources/book/meta_explainers/surrogates/explanation_generation.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download notebook file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../../_sources/book/meta_explainers/surrogates/explanation_generation.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/xmlx-io/xml-book"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/xmlx-io/xml-book/issues/new?title=Issue%20on%20page%20%2Fbook/meta_explainers/surrogates/explanation_generation.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/xmlx-io/xml-book/edit/master/book/meta_explainers/surrogates/explanation_generation.md"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/xmlx-io/xml-book/master?urlpath=lab/tree/book/meta_explainers/surrogates/explanation_generation.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#toy-example-two-moons">
   1.3.1. Toy Example – Two Moons
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#loading-the-data">
     Loading the Data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#loading-the-black-box-models">
     Loading the Black-Box Models
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#selecting-an-instance-to-be-explained">
     Selecting an Instance to be Explained
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sampling-data">
     Sampling Data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#building-interpretable-representation">
     Building Interpretable Representation
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#quartile-based-interpretable-representation">
       Quartile-based Interpretable Representation
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tree-based-interpretable-representation">
       Tree-based Interpretable Representation
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Explanation Generation
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#data-weighting">
       Data Weighting
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#original-data-domain">
         Original Data Domain
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#discretised-data-domain">
         Discretised Data Domain
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#binarised-data-domain">
         Binarised Data Domain
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#explanation-sparsity">
       Explanation Sparsity
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#surrogate-model-fitting">
       Surrogate Model Fitting
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#lime-like">
         LIME-like
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#rulefit-like">
         RuleFit-like
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#tree-based-explainer">
         Tree-based Explainer
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#bikes-data-set">
   1.3.2. Bikes Data Set
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#loading-data-and-black-boxes">
     Loading Data and Black Boxes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#choosing-an-instance">
     Choosing an Instance
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     Sampling Data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#lime-like-explainer">
     LIME-like Explainer
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#interpretable-representation">
       Interpretable Representation
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id3">
       Explanation Generation
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#instance-weighting">
         Instance Weighting
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#interpretable-feature-selection">
         Interpretable Feature Selection
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#id4">
         Explanation Generation
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#rulefit-like-explainer">
     RuleFit-like Explainer
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id5">
       Tree-based Interpretable Representation
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id6">
       Explanation Generation
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tree-based-local-surrogate">
     Tree-based Local Surrogate
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#single-output-regression-surrogate">
       Single-output Regression Surrogate
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#multi-output-regression-surrogate">
       Multi-output Regression Surrogate
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary">
   1.3.3. Summary
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ready-made-explainers">
     Ready-made Explainers
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tabularblimeylime">
       TabularBlimeyLime
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tabularblimeytree">
       TabularBlimeyTree
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#final-remarks">
     Final Remarks
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Explanation Generation</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#toy-example-two-moons">
   1.3.1. Toy Example – Two Moons
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#loading-the-data">
     Loading the Data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#loading-the-black-box-models">
     Loading the Black-Box Models
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#selecting-an-instance-to-be-explained">
     Selecting an Instance to be Explained
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sampling-data">
     Sampling Data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#building-interpretable-representation">
     Building Interpretable Representation
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#quartile-based-interpretable-representation">
       Quartile-based Interpretable Representation
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tree-based-interpretable-representation">
       Tree-based Interpretable Representation
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Explanation Generation
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#data-weighting">
       Data Weighting
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#original-data-domain">
         Original Data Domain
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#discretised-data-domain">
         Discretised Data Domain
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#binarised-data-domain">
         Binarised Data Domain
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#explanation-sparsity">
       Explanation Sparsity
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#surrogate-model-fitting">
       Surrogate Model Fitting
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#lime-like">
         LIME-like
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#rulefit-like">
         RuleFit-like
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#tree-based-explainer">
         Tree-based Explainer
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#bikes-data-set">
   1.3.2. Bikes Data Set
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#loading-data-and-black-boxes">
     Loading Data and Black Boxes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#choosing-an-instance">
     Choosing an Instance
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     Sampling Data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#lime-like-explainer">
     LIME-like Explainer
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#interpretable-representation">
       Interpretable Representation
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id3">
       Explanation Generation
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#instance-weighting">
         Instance Weighting
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#interpretable-feature-selection">
         Interpretable Feature Selection
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#id4">
         Explanation Generation
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#rulefit-like-explainer">
     RuleFit-like Explainer
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id5">
       Tree-based Interpretable Representation
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id6">
       Explanation Generation
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tree-based-local-surrogate">
     Tree-based Local Surrogate
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#single-output-regression-surrogate">
       Single-output Regression Surrogate
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#multi-output-regression-surrogate">
       Multi-output Regression Surrogate
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary">
   1.3.3. Summary
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ready-made-explainers">
     Ready-made Explainers
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tabularblimeylime">
       TabularBlimeyLime
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tabularblimeytree">
       TabularBlimeyTree
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#final-remarks">
     Final Remarks
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="explanation-generation">
<span id="text-meta-explainers-surrogates-explanation-generation"></span><h1><span class="section-number">1.3. </span>Explanation Generation<a class="headerlink" href="#explanation-generation" title="Permalink to this headline">¶</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># First, we need to set up the environment.</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;../../../_code&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">fatf</span>
<span class="kn">import</span> <span class="nn">xml_book.data</span>
<span class="kn">import</span> <span class="nn">xml_book.models</span>
<span class="kn">import</span> <span class="nn">xml_book.surrogates</span>

<span class="kn">import</span> <span class="nn">fatf.utils.data.augmentation</span> <span class="k">as</span> <span class="nn">fatf_augmentation</span>

<span class="kn">import</span> <span class="nn">fatf.utils.data.discretisation</span> <span class="k">as</span> <span class="nn">fatf_discretisation</span>
<span class="kn">import</span> <span class="nn">fatf.utils.data.transformation</span> <span class="k">as</span> <span class="nn">fatf_transformation</span>

<span class="kn">import</span> <span class="nn">fatf.utils.distances</span> <span class="k">as</span> <span class="nn">fatf_distances</span>
<span class="kn">import</span> <span class="nn">fatf.utils.kernels</span> <span class="k">as</span> <span class="nn">fatf_kernels</span>

<span class="kn">import</span> <span class="nn">fatf.utils.data.feature_selection.sklearn</span> <span class="k">as</span> <span class="nn">fatf_feature_selection_skl</span>

<span class="kn">import</span> <span class="nn">sklearn.metrics.pairwise</span>
<span class="kn">import</span> <span class="nn">sklearn.tree</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>22-Mar-21 18:34:27 fatf.utils.array.tools INFO     Using numpy&#39;s numpy.lib.recfunctions.structured_to_unstructured as fatf.utils.array.tools.structured_to_unstructured and fatf.utils.array.tools.structured_to_unstructured_row.
</pre></div>
</div>
</div>
</div>
<p>This notebook combines insights from the <em>Interpretable Representations</em> and
<em>Data Sampling</em> exercises with the <em>Explanation Generation</em> step to build
local surrogate models.
It shows how to <em>weight data</em> and <em>achieve explanation sparsity</em> when
composing explanations of black-box predictions.
In particular, we discuss:</p>
<ul class="simple">
<li><p>a range of distance functions;</p></li>
<li><p>kernels for transforming distances into similarity scores;</p></li>
<li><p>(interpretable) feature selection mechanisms to introduce explanation sparsity;</p></li>
<li><p>choice of surrogate model types; and</p></li>
<li><p>types of explanations that can be generated, their meaning and interpretation.</p></li>
</ul>
<p>We introduce these procedures for the <em>Two Moons</em> data set, which helps us
to convey the core concepts with visualisations.
Then, we move on to the more complicated example with the <em>Bikes Sharing</em> data
set.</p>
<section id="toy-example-two-moons">
<h2><span class="section-number">1.3.1. </span>Toy Example – Two Moons<a class="headerlink" href="#toy-example-two-moons" title="Permalink to this headline">¶</a></h2>
<section id="loading-the-data">
<h3>Loading the Data<a class="headerlink" href="#loading-the-data" title="Permalink to this headline">¶</a></h3>
<p>First, we load the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">moons_X</span><span class="p">,</span> <span class="n">moons_X_test</span><span class="p">,</span> <span class="n">moons_y</span><span class="p">,</span> <span class="n">moons_y_test</span> <span class="o">=</span> <span class="n">xml_book</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">generate_2d_moons</span><span class="p">(</span>
    <span class="n">random_seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>22-Mar-21 18:34:28 fatf         INFO     Seeding RNGs using the input parameter.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>22-Mar-21 18:34:28 fatf         INFO     Seeding RNGs with 42.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>    <span class="c1"># Plot data</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">moons_X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">moons_X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">moons_y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.collections.PathCollection at 0x11b2e4220&gt;
</pre></div>
</div>
<img alt="../../../_images/explanation_generation_6_1.png" src="../../../_images/explanation_generation_6_1.png" />
</div>
</div>
</section>
<section id="loading-the-black-box-models">
<h3>Loading the Black-Box Models<a class="headerlink" href="#loading-the-black-box-models" title="Permalink to this headline">¶</a></h3>
<p>Next, we load our <em>crisp</em> and <em>probabilistic</em> black boxes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clf_moons_proba</span> <span class="o">=</span> <span class="n">xml_book</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">get_random_forest</span><span class="p">(</span>
    <span class="n">moons_X</span><span class="p">,</span> <span class="n">moons_y</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>22-Mar-21 18:34:28 fatf         INFO     Seeding RNGs using the input parameter.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>22-Mar-21 18:34:28 fatf         INFO     Seeding RNGs with 42.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clf_moons_crisp</span> <span class="o">=</span> <span class="n">xml_book</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">get_svc</span><span class="p">(</span>
    <span class="n">moons_X</span><span class="p">,</span> <span class="n">moons_y</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>22-Mar-21 18:34:28 fatf         INFO     Seeding RNGs using the input parameter.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>22-Mar-21 18:34:28 fatf         INFO     Seeding RNGs with 42.
</pre></div>
</div>
</div>
</div>
</section>
<section id="selecting-an-instance-to-be-explained">
<h3>Selecting an Instance to be Explained<a class="headerlink" href="#selecting-an-instance-to-be-explained" title="Permalink to this headline">¶</a></h3>
<p>For the Two Moons data set, we will generate explanations for a data point
close to a decision boundary.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">moons_boundary_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the points we are going to sample around</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">moons_X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">moons_X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">moons_y</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">moons_boundary_point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">moons_boundary_point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Boundary Point&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x11b3f3eb0&gt;
</pre></div>
</div>
<img alt="../../../_images/explanation_generation_12_1.png" src="../../../_images/explanation_generation_12_1.png" />
</div>
</div>
</section>
<section id="sampling-data">
<h3>Sampling Data<a class="headerlink" href="#sampling-data" title="Permalink to this headline">¶</a></h3>
<p>Having seen how different samplers perform on this particular data set
(cf. <code class="docutils literal notranslate"><span class="pre">3-data-sampling.ipynb</span></code>), we opt for <em>Mixup</em> and we sample 250 data
points.
Also, we sample in the original data domain to avoid randomness entailed by
the “reverse sampling” step.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">moons_mixup_sampler</span> <span class="o">=</span> <span class="n">fatf_augmentation</span><span class="o">.</span><span class="n">Mixup</span><span class="p">(</span>
    <span class="n">moons_X_test</span><span class="p">,</span> <span class="n">moons_y_test</span><span class="p">)</span>

<span class="n">moons_samples_number</span> <span class="o">=</span> <span class="mi">250</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">moons_mixup_sample_close</span> <span class="o">=</span> <span class="n">moons_mixup_sampler</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
    <span class="n">moons_boundary_point</span><span class="p">,</span>
    <span class="n">samples_number</span><span class="o">=</span><span class="n">moons_samples_number</span><span class="p">)</span>

<span class="n">moons_mixup_sample_close_crisp</span> <span class="o">=</span> <span class="n">clf_moons_crisp</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
    <span class="n">moons_mixup_sample_close</span><span class="p">)</span>

<span class="n">moons_mixup_sample_close_proba</span> <span class="o">=</span> <span class="n">clf_moons_proba</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span>
    <span class="n">moons_mixup_sample_close</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s measure the diversity of our sample.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xml_book</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">gini_index</span><span class="p">(</span><span class="n">moons_mixup_sample_close_crisp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.456192
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">moons_X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">moons_X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">moons_y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">moons_boundary_point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">moons_boundary_point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Boundary Point&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">moons_mixup_sample_close</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">moons_mixup_sample_close</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">moons_mixup_sample_close_crisp</span><span class="p">,</span>
    <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(-0.1, 1.1)
</pre></div>
</div>
<img alt="../../../_images/explanation_generation_18_1.png" src="../../../_images/explanation_generation_18_1.png" />
</div>
</div>
</section>
<section id="building-interpretable-representation">
<h3>Building Interpretable Representation<a class="headerlink" href="#building-interpretable-representation" title="Permalink to this headline">¶</a></h3>
<p>Next, we compose two types of binary interpretable representations:</p>
<ul class="simple">
<li><p>binarised, quartile-based discretisation
(it worked well for this particular data set); and</p></li>
<li><p>one-hot encoded tree-based discretisation.</p></li>
</ul>
<section id="quartile-based-interpretable-representation">
<h4>Quartile-based Interpretable Representation<a class="headerlink" href="#quartile-based-interpretable-representation" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">q_discretiser_moons</span> <span class="o">=</span> <span class="n">fatf_discretisation</span><span class="o">.</span><span class="n">QuartileDiscretiser</span><span class="p">(</span><span class="n">moons_X_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s discretise the sample and the explained instance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">moons_mixup_sample_close_q_discrete</span> <span class="o">=</span> <span class="n">q_discretiser_moons</span><span class="o">.</span><span class="n">discretise</span><span class="p">(</span>
    <span class="n">moons_mixup_sample_close</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">moons_boundary_point_q_discrete</span> <span class="o">=</span> <span class="n">q_discretiser_moons</span><span class="o">.</span><span class="n">discretise</span><span class="p">(</span>
    <span class="n">moons_boundary_point</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now, we will binarise it.
(Recall that the binary representation of the explained instance is
an all-<span class="math notranslate nohighlight">\(1\)</span> vector.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">moons_mixup_sample_close_q_binary</span> <span class="o">=</span> <span class="n">fatf_transformation</span><span class="o">.</span><span class="n">dataset_row_masking</span><span class="p">(</span>
    <span class="n">moons_mixup_sample_close_q_discrete</span><span class="p">,</span> <span class="n">moons_boundary_point_q_discrete</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">moons_boundary_point_q_binary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span>
    <span class="n">moons_boundary_point_q_discrete</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s visualise these two steps.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">moons_X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">moons_X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">moons_y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="c1"># Plot data using a unique marker for each binary encoding</span>
<span class="n">moons_unique_binary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">moons_mixup_sample_close_q_binary</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="n">moons_unique_binary</span><span class="p">:</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">xml_book</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">get_hyperrectangle_indices</span><span class="p">(</span>
        <span class="n">moons_mixup_sample_close_q_binary</span><span class="p">,</span> <span class="n">rep</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]):</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;v&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">c</span><span class="o">=</span><span class="n">moons_mixup_sample_close_crisp</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="c1"># Plot explained instance</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">moons_boundary_point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">moons_boundary_point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Boundary Point&#39;</span><span class="p">)</span>

<span class="c1"># Plot x-axis quartiles</span>
<span class="n">x_quartiles_m</span> <span class="o">=</span> <span class="n">q_discretiser_moons</span><span class="o">.</span><span class="n">feature_bin_boundaries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x_quartiles_m</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="c1"># Plot y-axis quartiles</span>
<span class="n">y_quartiles_m</span> <span class="o">=</span> <span class="n">q_discretiser_moons</span><span class="o">.</span><span class="n">feature_bin_boundaries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">y_quartiles_m</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="c1"># Plot binarisation of the x-axis</span>
<span class="n">hyper_rectangle_m_x</span> <span class="o">=</span> <span class="n">moons_boundary_point_q_discrete</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">hyper_rectangle_m_x</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_x_min</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_x_max</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_x_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
    <span class="n">hyper_rectangle_m_x_max</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_x</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_x_min</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_x_max</span> <span class="o">=</span> <span class="mf">1.1</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">hyper_rectangle_m_x_min</span><span class="p">,</span> <span class="n">hyper_rectangle_m_x_max</span><span class="p">,</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="c1"># Plot binarisation of the y-axis</span>
<span class="n">hyper_rectangle_m_y</span> <span class="o">=</span> <span class="n">moons_boundary_point_q_discrete</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">hyper_rectangle_m_y</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_y_min</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_y_max</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_y_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
    <span class="n">hyper_rectangle_m_y_max</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_y</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_y_min</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_y_max</span> <span class="o">=</span> <span class="mf">1.1</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span><span class="n">hyper_rectangle_m_y_min</span><span class="p">,</span> <span class="n">hyper_rectangle_m_y_max</span><span class="p">,</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/d0/9mvcgn8503s6975cz1p09rmc0000gn/T/ipykernel_68128/2530916095.py:25: UserWarning: You passed a edgecolor/edgecolors (&#39;b&#39;) for an unfilled marker (&#39;x&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  plt.scatter(moons_mixup_sample_close[indices, 0],
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.patches.Polygon at 0x11b40ac40&gt;
</pre></div>
</div>
<img alt="../../../_images/explanation_generation_29_2.png" src="../../../_images/explanation_generation_29_2.png" />
</div>
</div>
<p>In the plot above:</p>
<ul class="simple">
<li><p>colour encodes the class (red or grey) predicted by our crisp
black-box model;</p></li>
<li><p>blue dashed lines show quartile boundaries; and</p></li>
<li><p>each marker shape encodes a unique binary representation:</p>
<ul>
<li><p><span class="math notranslate nohighlight">\(\star\)</span> – <span class="math notranslate nohighlight">\((1,1)\)</span>,</p></li>
<li><p><span class="math notranslate nohighlight">\(\times\)</span> – <span class="math notranslate nohighlight">\((1, 0)\)</span>,</p></li>
<li><p><span class="math notranslate nohighlight">\(\nabla\)</span> – <span class="math notranslate nohighlight">\((0, 1)\)</span>, and</p></li>
<li><p><span class="math notranslate nohighlight">\(\bullet\)</span> – <span class="math notranslate nohighlight">\((0, 0)\)</span>.</p></li>
</ul>
</li>
</ul>
<p>Finally, let’s measure purity of our discrete and binary representations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xml_book</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">weighted_purity</span><span class="p">(</span>
    <span class="n">moons_mixup_sample_close_q_discrete</span><span class="p">,</span>
    <span class="n">moons_mixup_sample_close_crisp</span><span class="p">,</span>
    <span class="s1">&#39;gini&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.1621015873015873
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xml_book</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">weighted_purity</span><span class="p">(</span>
    <span class="n">moons_mixup_sample_close_q_binary</span><span class="p">,</span>
    <span class="n">moons_mixup_sample_close_crisp</span><span class="p">,</span>
    <span class="s1">&#39;gini&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.4146381516237152
</pre></div>
</div>
</div>
</div>
</section>
<section id="tree-based-interpretable-representation">
<h4>Tree-based Interpretable Representation<a class="headerlink" href="#tree-based-interpretable-representation" title="Permalink to this headline">¶</a></h4>
<p>Let’s move on to a tree-based interpretable representation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tree_binariser_moons</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">DecisionTreeClassifier</span><span class="p">(</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_leaf_nodes</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">min_impurity_decrease</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">tree_binariser_moons</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">moons_mixup_sample_close</span><span class="p">,</span>
                         <span class="n">moons_mixup_sample_close_crisp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DecisionTreeClassifier(max_leaf_nodes=4, min_impurity_decrease=0.05,
                       random_state=42)
</pre></div>
</div>
</div>
</div>
<p>First, we get the discrete…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">moons_mixup_sample_close_tree_discrete</span> <span class="o">=</span> <span class="n">tree_binariser_moons</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="n">moons_mixup_sample_close</span><span class="p">)</span>
<span class="n">moons_boundary_point_tree_discrete</span> <span class="o">=</span> <span class="n">tree_binariser_moons</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="p">[</span><span class="n">moons_boundary_point</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># scikit-learn only accepts 2-D data</span>
</pre></div>
</div>
</div>
</div>
<p>…then binary (one-hot encoded) representation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">moons_mixup_sample_close_tree_binary</span> <span class="o">=</span> <span class="n">xml_book</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">one_hot_encode</span><span class="p">(</span>
    <span class="n">moons_mixup_sample_close_tree_discrete</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">xml_book.surrogates.one_hot_encode</span></code> function is incapable of handling a
single instance, therefore we have to process it manually.
To this end, we get all the unique IDs of our tree-based discretisation,
sort them, and get the index of the element that the discretisation
of the explained instance matches.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">unique</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">moons_mixup_sample_close_tree_discrete</span><span class="p">))</span>
<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">unique</span> <span class="o">==</span> <span class="n">moons_boundary_point_tree_discrete</span><span class="p">)</span>

<span class="n">moons_boundary_point_tree_binary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
    <span class="n">unique</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
<span class="n">moons_boundary_point_tree_binary</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s visualise our tree-based partition.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>

<span class="c1"># Compute the decision boundary of the tree</span>
<span class="n">x_y_step</span> <span class="o">=</span> <span class="mf">0.005</span>
<span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span>
<span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span>
<span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">x_y_step</span><span class="p">),</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">x_y_step</span><span class="p">))</span>

<span class="n">Z</span> <span class="o">=</span> <span class="n">tree_binariser_moons</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span>

<span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">Z_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">Z</span><span class="p">)):</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">Z</span> <span class="o">==</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">Z_norm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

<span class="c1"># Plot the boundary</span>
<span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">Z_norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">tab20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="c1"># Plot data</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">moons_X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">moons_X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">moons_y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="c1"># Plot explained instance</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">moons_boundary_point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">moons_boundary_point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Boundary Point&#39;</span><span class="p">)</span>

<span class="c1"># Plot data using a unique marker for each encoding</span>
<span class="n">moons_unique_binary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">moons_mixup_sample_close_tree_discrete</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">markers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="n">moons_unique_binary</span><span class="p">:</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">xml_book</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">get_hyperrectangle_indices</span><span class="p">(</span>
        <span class="n">moons_mixup_sample_close_tree_discrete</span><span class="p">,</span> <span class="n">rep</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="n">moons_boundary_point_tree_discrete</span><span class="p">):</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="n">markers</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">c</span><span class="o">=</span><span class="n">moons_mixup_sample_close_crisp</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/explanation_generation_42_0.png" src="../../../_images/explanation_generation_42_0.png" />
</div>
</div>
<p>And, finally, compute its purity.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xml_book</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">weighted_purity</span><span class="p">(</span>
    <span class="n">moons_mixup_sample_close_tree_discrete</span><span class="p">,</span>
    <span class="n">moons_mixup_sample_close_crisp</span><span class="p">,</span>
    <span class="s1">&#39;gini&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.2207166591827571
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id1">
<h3>Explanation Generation<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Now, we are ready to explain some black-box predictions.
In addition to <em>training a local surrogate model</em>, this procedure
may involve <strong>weighting</strong> the data sample and <strong>reducing</strong> the number
of interpretable features.</p>
<section id="data-weighting">
<h4>Data Weighting<a class="headerlink" href="#data-weighting" title="Permalink to this headline">¶</a></h4>
<p>To enforce the locality of an explanation even further (this has already
been achieved with a local data sample), we can weight the sampled data.
To this end, we need to compute the distance between the sample and the
explained instance, and kernelise these measures to transform them into
<em>similarity</em> scores.</p>
<p>We will compute and visualise three different distance metrics:</p>
<ul class="simple">
<li><p>Manhattan;</p></li>
<li><p>Euclidean; and</p></li>
<li><p>cosine.</p></li>
</ul>
<p>We will investigate the effect of computing them in different representations:</p>
<ul class="simple">
<li><p>the original data domain;</p></li>
<li><p>discrete representation; and</p></li>
<li><p>binary representation.</p></li>
</ul>
<p>Then, we will experiment with different parameterisations of the exponential
kernel:</p>
<div class="math notranslate nohighlight">
\[\mathcal{K}(\mathbf{d}) = \sqrt{exp\left(-\frac{\mathbf{d}^2}{w^2}\right)}\]</div>
<p>setting <span class="math notranslate nohighlight">\(\mathbf{d}\)</span> to:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(1.00\)</span>,</p></li>
<li><p><span class="math notranslate nohighlight">\(0.10\)</span> and</p></li>
<li><p><span class="math notranslate nohighlight">\(0.01\)</span>.</p></li>
</ul>
<section id="original-data-domain">
<h5>Original Data Domain<a class="headerlink" href="#original-data-domain" title="Permalink to this headline">¶</a></h5>
<p>Let’s start with the original data domain.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">manhattan</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">pairwise</span><span class="o">.</span><span class="n">manhattan_distances</span><span class="p">(</span>
    <span class="p">[</span><span class="n">moons_boundary_point</span><span class="p">],</span> <span class="n">moons_mixup_sample_close</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">euclidean</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">pairwise</span><span class="o">.</span><span class="n">euclidean_distances</span><span class="p">(</span>
    <span class="p">[</span><span class="n">moons_boundary_point</span><span class="p">],</span> <span class="n">moons_mixup_sample_close</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">cosine</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">pairwise</span><span class="o">.</span><span class="n">cosine_distances</span><span class="p">(</span>
    <span class="p">[</span><span class="n">moons_boundary_point</span><span class="p">],</span> <span class="n">moons_mixup_sample_close</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">moons_X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">moons_X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">moons_y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Manhattan&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Euclidean&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Cosine&#39;</span><span class="p">)</span>

<span class="c1"># Plot explained instance</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">moons_boundary_point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">moons_boundary_point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Boundary Point&#39;</span><span class="p">)</span>

<span class="c1"># Plot x-axis quartiles</span>
<span class="n">x_quartiles_m</span> <span class="o">=</span> <span class="n">q_discretiser_moons</span><span class="o">.</span><span class="n">feature_bin_boundaries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x_quartiles_m</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="c1"># Plot y-axis quartiles</span>
<span class="n">y_quartiles_m</span> <span class="o">=</span> <span class="n">q_discretiser_moons</span><span class="o">.</span><span class="n">feature_bin_boundaries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">y_quartiles_m</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="c1"># Plot binarisation of the x-axis</span>
<span class="n">hyper_rectangle_m_x</span> <span class="o">=</span> <span class="n">moons_boundary_point_q_discrete</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">hyper_rectangle_m_x</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_x_min</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_x_max</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_x_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
    <span class="n">hyper_rectangle_m_x_max</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_x</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_x_min</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_x_max</span> <span class="o">=</span> <span class="mf">1.1</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span>
        <span class="n">hyper_rectangle_m_x_min</span><span class="p">,</span>
        <span class="n">hyper_rectangle_m_x_max</span><span class="p">,</span>
        <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="c1"># Plot binarisation of the y-axis</span>
<span class="n">hyper_rectangle_m_y</span> <span class="o">=</span> <span class="n">moons_boundary_point_q_discrete</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">hyper_rectangle_m_y</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_y_min</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_y_max</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_y_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
    <span class="n">hyper_rectangle_m_y_max</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_y</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_y_min</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_y_max</span> <span class="o">=</span> <span class="mf">1.1</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span>
        <span class="n">hyper_rectangle_m_y_min</span><span class="p">,</span>
        <span class="n">hyper_rectangle_m_y_max</span><span class="p">,</span>
        <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="c1"># Plot data using a unique marker for each binary encoding</span>
<span class="n">moons_unique_binary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">moons_mixup_sample_close_q_binary</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="n">moons_unique_binary</span><span class="p">:</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">xml_book</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">get_hyperrectangle_indices</span><span class="p">(</span>
        <span class="n">moons_mixup_sample_close_q_binary</span><span class="p">,</span> <span class="n">rep</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]):</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;v&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span>

    <span class="n">dist</span> <span class="o">=</span> <span class="n">manhattan</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                   <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                   <span class="n">c</span><span class="o">=</span><span class="n">moons_mixup_sample_close_crisp</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>
                   <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span>
                   <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                   <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
                   <span class="n">s</span><span class="o">=</span><span class="mi">200</span> <span class="o">*</span> <span class="n">dist</span><span class="p">)</span>

    <span class="n">dist</span> <span class="o">=</span> <span class="n">euclidean</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                   <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                   <span class="n">c</span><span class="o">=</span><span class="n">moons_mixup_sample_close_crisp</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>
                   <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span>
                   <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                   <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
                   <span class="n">s</span><span class="o">=</span><span class="mi">200</span> <span class="o">*</span> <span class="n">dist</span><span class="p">)</span>

    <span class="n">dist</span> <span class="o">=</span> <span class="n">cosine</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                   <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                   <span class="n">c</span><span class="o">=</span><span class="n">moons_mixup_sample_close_crisp</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>
                   <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span>
                   <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                   <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
                   <span class="n">s</span><span class="o">=</span><span class="mi">200</span> <span class="o">*</span> <span class="n">dist</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/d0/9mvcgn8503s6975cz1p09rmc0000gn/T/ipykernel_68128/398580212.py:85: UserWarning: You passed a edgecolor/edgecolors (&#39;b&#39;) for an unfilled marker (&#39;x&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  axs[0].scatter(moons_mixup_sample_close[indices, 0],
/var/folders/d0/9mvcgn8503s6975cz1p09rmc0000gn/T/ipykernel_68128/398580212.py:94: UserWarning: You passed a edgecolor/edgecolors (&#39;b&#39;) for an unfilled marker (&#39;x&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  axs[1].scatter(moons_mixup_sample_close[indices, 0],
/var/folders/d0/9mvcgn8503s6975cz1p09rmc0000gn/T/ipykernel_68128/398580212.py:103: UserWarning: You passed a edgecolor/edgecolors (&#39;b&#39;) for an unfilled marker (&#39;x&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  axs[2].scatter(moons_mixup_sample_close[indices, 0],
</pre></div>
</div>
<img alt="../../../_images/explanation_generation_49_1.png" src="../../../_images/explanation_generation_49_1.png" />
</div>
</div>
<p>Let’s kernelise them using the exponential kernel.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">manhattan_k_100</span> <span class="o">=</span> <span class="n">fatf_kernels</span><span class="o">.</span><span class="n">exponential_kernel</span><span class="p">(</span>
    <span class="n">manhattan</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">manhattan_k_010</span> <span class="o">=</span> <span class="n">fatf_kernels</span><span class="o">.</span><span class="n">exponential_kernel</span><span class="p">(</span>
    <span class="n">manhattan</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">manhattan_k_001</span> <span class="o">=</span> <span class="n">fatf_kernels</span><span class="o">.</span><span class="n">exponential_kernel</span><span class="p">(</span>
    <span class="n">manhattan</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">manhattan_k</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="n">manhattan_k_100</span><span class="p">,</span>
    <span class="s1">&#39;0.1&#39;</span><span class="p">:</span> <span class="n">manhattan_k_010</span><span class="p">,</span>
    <span class="s1">&#39;0.01&#39;</span><span class="p">:</span> <span class="n">manhattan_k_001</span>
<span class="p">}</span>

<span class="n">euclidean_k_100</span> <span class="o">=</span> <span class="n">fatf_kernels</span><span class="o">.</span><span class="n">exponential_kernel</span><span class="p">(</span>
    <span class="n">euclidean</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">euclidean_k_010</span> <span class="o">=</span> <span class="n">fatf_kernels</span><span class="o">.</span><span class="n">exponential_kernel</span><span class="p">(</span>
    <span class="n">euclidean</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">euclidean_k_001</span> <span class="o">=</span> <span class="n">fatf_kernels</span><span class="o">.</span><span class="n">exponential_kernel</span><span class="p">(</span>
    <span class="n">euclidean</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">.01</span><span class="p">)</span>
<span class="n">euclidean_k</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="n">euclidean_k_100</span><span class="p">,</span>
    <span class="s1">&#39;0.1&#39;</span><span class="p">:</span> <span class="n">euclidean_k_010</span><span class="p">,</span>
    <span class="s1">&#39;0.01&#39;</span><span class="p">:</span> <span class="n">euclidean_k_001</span>
<span class="p">}</span>

<span class="n">cosine_k_100</span> <span class="o">=</span> <span class="n">fatf_kernels</span><span class="o">.</span><span class="n">exponential_kernel</span><span class="p">(</span>
    <span class="n">cosine</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">cosine_k_010</span> <span class="o">=</span> <span class="n">fatf_kernels</span><span class="o">.</span><span class="n">exponential_kernel</span><span class="p">(</span>
    <span class="n">cosine</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">cosine_k_001</span> <span class="o">=</span> <span class="n">fatf_kernels</span><span class="o">.</span><span class="n">exponential_kernel</span><span class="p">(</span>
    <span class="n">cosine</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">.01</span><span class="p">)</span>
<span class="n">cosine_k</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="n">cosine_k_100</span><span class="p">,</span>
    <span class="s1">&#39;0.1&#39;</span><span class="p">:</span> <span class="n">cosine_k_010</span><span class="p">,</span>
    <span class="s1">&#39;0.01&#39;</span><span class="p">:</span> <span class="n">cosine_k_001</span>
<span class="p">}</span>

<span class="n">names_k</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;0.1&#39;</span><span class="p">,</span> <span class="s1">&#39;0.01&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ay</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">moons_X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">moons_X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">moons_y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Manhattan&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Euclidean&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Cosine&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names_k</span><span class="p">):</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;k=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="c1"># Plot x-axis quartiles</span>
<span class="n">x_quartiles_m</span> <span class="o">=</span> <span class="n">q_discretiser_moons</span><span class="o">.</span><span class="n">feature_bin_boundaries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x_quartiles_m</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ay</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="c1"># Plot y-axis quartiles</span>
<span class="n">y_quartiles_m</span> <span class="o">=</span> <span class="n">q_discretiser_moons</span><span class="o">.</span><span class="n">feature_bin_boundaries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">y_quartiles_m</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ay</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="p">[</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="c1"># Plot binarisation of the x-axis</span>
<span class="n">hyper_rectangle_m_x</span> <span class="o">=</span> <span class="n">moons_boundary_point_q_discrete</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">hyper_rectangle_m_x</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_x_min</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_x_max</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_x_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
    <span class="n">hyper_rectangle_m_x_max</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_x</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_x_min</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_x_max</span> <span class="o">=</span> <span class="mf">1.1</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ay</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span>
            <span class="n">hyper_rectangle_m_x_min</span><span class="p">,</span>
            <span class="n">hyper_rectangle_m_x_max</span><span class="p">,</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="c1"># Plot binarisation of the y-axis</span>
<span class="n">hyper_rectangle_m_y</span> <span class="o">=</span> <span class="n">moons_boundary_point_q_discrete</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">hyper_rectangle_m_y</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_y_min</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_y_max</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_y_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
    <span class="n">hyper_rectangle_m_y_max</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_y</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_y_min</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_y_max</span> <span class="o">=</span> <span class="mf">1.1</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ay</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">]</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span>
            <span class="n">hyper_rectangle_m_y_min</span><span class="p">,</span>
            <span class="n">hyper_rectangle_m_y_max</span><span class="p">,</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="c1"># Plot data using a unique marker for each binary encoding</span>
<span class="n">moons_unique_binary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">moons_mixup_sample_close_q_binary</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="n">moons_unique_binary</span><span class="p">:</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">xml_book</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">get_hyperrectangle_indices</span><span class="p">(</span>
        <span class="n">moons_mixup_sample_close_q_binary</span><span class="p">,</span> <span class="n">rep</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]):</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;v&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span>

    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names_k</span><span class="p">):</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="n">manhattan_k</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">c</span><span class="o">=</span><span class="n">moons_mixup_sample_close_crisp</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
            <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">200</span> <span class="o">*</span> <span class="n">sim</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names_k</span><span class="p">):</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="n">euclidean_k</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">c</span><span class="o">=</span><span class="n">moons_mixup_sample_close_crisp</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
            <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">200</span> <span class="o">*</span> <span class="n">sim</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names_k</span><span class="p">):</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="n">cosine_k</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">c</span><span class="o">=</span><span class="n">moons_mixup_sample_close_crisp</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
            <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">200</span> <span class="o">*</span> <span class="n">sim</span><span class="p">)</span>

<span class="c1"># Plot explained instance</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ay</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">moons_boundary_point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">moons_boundary_point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Boundary Point&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/d0/9mvcgn8503s6975cz1p09rmc0000gn/T/ipykernel_68128/3304955845.py:90: UserWarning: You passed a edgecolor/edgecolors (&#39;b&#39;) for an unfilled marker (&#39;x&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  axs[ax, 0].scatter(
/var/folders/d0/9mvcgn8503s6975cz1p09rmc0000gn/T/ipykernel_68128/3304955845.py:101: UserWarning: You passed a edgecolor/edgecolors (&#39;b&#39;) for an unfilled marker (&#39;x&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  axs[ax, 1].scatter(
/var/folders/d0/9mvcgn8503s6975cz1p09rmc0000gn/T/ipykernel_68128/3304955845.py:112: UserWarning: You passed a edgecolor/edgecolors (&#39;b&#39;) for an unfilled marker (&#39;x&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  axs[ax, 2].scatter(
</pre></div>
</div>
<img alt="../../../_images/explanation_generation_52_1.png" src="../../../_images/explanation_generation_52_1.png" />
</div>
</div>
<p>As you can see, the <strong>distance type</strong> and <strong>kernel parameterisation</strong>
have quite strong influence on importance of the instances when fitting
a local surrogate model.
Keep in mind that these weights could have been used to discretise the data
in the first place – we will see such an effect for tree-learnt interpretable
representation.</p>
<hr class="docutils" />
<p>Now, let’s investigate how these weights influence the discretisation produced
by a tree.
Note that this can only be done for weights computed in the original data
domain.</p>
<p>This behaviour is introduced by the <code class="docutils literal notranslate"><span class="pre">sample_weight</span></code> parameter to the
<code class="docutils literal notranslate"><span class="pre">DecisionTreeClassifier</span></code>’s <code class="docutils literal notranslate"><span class="pre">fit</span></code> method, e.g.:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">tree</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">DecisionTreeClassifier</span><span class="p">()</span>
<span class="n">tree</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute the decision boundary of the tree</span>
<span class="n">x_y_step</span> <span class="o">=</span> <span class="mf">0.005</span>
<span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span>
<span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span>
<span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">x_y_step</span><span class="p">),</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">x_y_step</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ay</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">moons_X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">moons_X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">moons_y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Manhattan&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Euclidean&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Cosine&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names_k</span><span class="p">):</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;k=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="c1"># Plot data using a unique marker for each binary encoding</span>
<span class="k">for</span> <span class="n">ay</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">manhattan_k</span><span class="p">,</span> <span class="n">euclidean_k</span><span class="p">,</span> <span class="n">cosine_k</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names_k</span><span class="p">):</span>
        <span class="n">tree_binariser_</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">DecisionTreeClassifier</span><span class="p">(</span>
            <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_leaf_nodes</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">min_impurity_decrease</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="n">tree_binariser_</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">moons_mixup_sample_close</span><span class="p">,</span>
                            <span class="n">moons_mixup_sample_close_crisp</span><span class="p">,</span>
                            <span class="n">sample_weight</span><span class="o">=</span><span class="n">w</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="n">discretised_sample</span> <span class="o">=</span> <span class="n">tree_binariser_</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">moons_mixup_sample_close</span><span class="p">)</span>
        <span class="n">discretised_explained</span> <span class="o">=</span> <span class="n">tree_binariser_</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="p">[</span><span class="n">moons_boundary_point</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Plot the boundary</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">tree_binariser_</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span>
        
        <span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">Z_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">Z</span><span class="p">)):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">Z</span> <span class="o">==</span> <span class="n">v</span><span class="p">)</span>
            <span class="n">Z_norm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
        
        <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">]</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">Z_norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">tab20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="c1"># Plot data using a unique marker for each encoding</span>
        <span class="n">moons_unique_binary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">discretised_sample</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">markers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="n">moons_unique_binary</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">xml_book</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">get_hyperrectangle_indices</span><span class="p">(</span>
                <span class="n">discretised_sample</span><span class="p">,</span> <span class="n">rep</span><span class="p">)</span>
        
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="n">discretised_explained</span><span class="p">):</span>
                <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">marker</span> <span class="o">=</span> <span class="n">markers</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        
            <span class="n">sim</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">c</span><span class="o">=</span><span class="n">moons_mixup_sample_close_crisp</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="mi">200</span> <span class="o">*</span> <span class="n">sim</span><span class="p">)</span>

<span class="c1"># Plot explained instance</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ay</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">moons_boundary_point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">moons_boundary_point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Boundary Point&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/d0/9mvcgn8503s6975cz1p09rmc0000gn/T/ipykernel_68128/3162818415.py:62: UserWarning: You passed a edgecolor/edgecolors (&#39;b&#39;) for an unfilled marker (&#39;x&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  axs[ax, ay].scatter(
</pre></div>
</div>
<img alt="../../../_images/explanation_generation_54_1.png" src="../../../_images/explanation_generation_54_1.png" />
</div>
</div>
<p>The green shading indicates trees with no splits, i.e.,
they predict the majority class according to the weighted
data sample.
Again, the effect is quite pronounced.</p>
</section>
<section id="discretised-data-domain">
<h5>Discretised Data Domain<a class="headerlink" href="#discretised-data-domain" title="Permalink to this headline">¶</a></h5>
<p>Now, let’s repeat the procedure for distances and weights computed in the discrete
domain based on quartiles.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">manhattan</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">pairwise</span><span class="o">.</span><span class="n">manhattan_distances</span><span class="p">(</span>
    <span class="p">[</span><span class="n">moons_boundary_point_q_discrete</span><span class="p">],</span> <span class="n">moons_mixup_sample_close_q_discrete</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">euclidean</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">pairwise</span><span class="o">.</span><span class="n">euclidean_distances</span><span class="p">(</span>
    <span class="p">[</span><span class="n">moons_boundary_point_q_discrete</span><span class="p">],</span> <span class="n">moons_mixup_sample_close_q_discrete</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">cosine</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">pairwise</span><span class="o">.</span><span class="n">cosine_distances</span><span class="p">(</span>
    <span class="p">[</span><span class="n">moons_boundary_point_q_discrete</span><span class="p">],</span> <span class="n">moons_mixup_sample_close_q_discrete</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">moons_X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">moons_X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">moons_y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Manhattan&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Euclidean&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Cosine&#39;</span><span class="p">)</span>

<span class="c1"># Plot explained instance</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">moons_boundary_point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">moons_boundary_point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Boundary Point&#39;</span><span class="p">)</span>

<span class="c1"># Plot x-axis quartiles</span>
<span class="n">x_quartiles_m</span> <span class="o">=</span> <span class="n">q_discretiser_moons</span><span class="o">.</span><span class="n">feature_bin_boundaries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x_quartiles_m</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="c1"># Plot y-axis quartiles</span>
<span class="n">y_quartiles_m</span> <span class="o">=</span> <span class="n">q_discretiser_moons</span><span class="o">.</span><span class="n">feature_bin_boundaries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">y_quartiles_m</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="c1"># Plot binarisation of the x-axis</span>
<span class="n">hyper_rectangle_m_x</span> <span class="o">=</span> <span class="n">moons_boundary_point_q_discrete</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">hyper_rectangle_m_x</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_x_min</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_x_max</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_x_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
    <span class="n">hyper_rectangle_m_x_max</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_x</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_x_min</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_x_max</span> <span class="o">=</span> <span class="mf">1.1</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span>
        <span class="n">hyper_rectangle_m_x_min</span><span class="p">,</span>
        <span class="n">hyper_rectangle_m_x_max</span><span class="p">,</span>
        <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="c1"># Plot binarisation of the y-axis</span>
<span class="n">hyper_rectangle_m_y</span> <span class="o">=</span> <span class="n">moons_boundary_point_q_discrete</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">hyper_rectangle_m_y</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_y_min</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_y_max</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_y_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
    <span class="n">hyper_rectangle_m_y_max</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_y</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_y_min</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_y_max</span> <span class="o">=</span> <span class="mf">1.1</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span>
        <span class="n">hyper_rectangle_m_y_min</span><span class="p">,</span>
        <span class="n">hyper_rectangle_m_y_max</span><span class="p">,</span>
        <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="c1"># Plot data using a unique marker for each binary encoding</span>
<span class="n">moons_unique_binary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">moons_mixup_sample_close_q_binary</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="n">moons_unique_binary</span><span class="p">:</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">xml_book</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">get_hyperrectangle_indices</span><span class="p">(</span>
        <span class="n">moons_mixup_sample_close_q_binary</span><span class="p">,</span> <span class="n">rep</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]):</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;v&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span>

    <span class="n">dist</span> <span class="o">=</span> <span class="n">manhattan</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                   <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                   <span class="n">c</span><span class="o">=</span><span class="n">moons_mixup_sample_close_crisp</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>
                   <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span>
                   <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                   <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
                   <span class="n">s</span><span class="o">=</span><span class="mi">100</span> <span class="o">*</span> <span class="n">dist</span><span class="p">)</span>

    <span class="n">dist</span> <span class="o">=</span> <span class="n">euclidean</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                   <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                   <span class="n">c</span><span class="o">=</span><span class="n">moons_mixup_sample_close_crisp</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>
                   <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span>
                   <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                   <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
                   <span class="n">s</span><span class="o">=</span><span class="mi">100</span> <span class="o">*</span> <span class="n">dist</span><span class="p">)</span>

    <span class="n">dist</span> <span class="o">=</span> <span class="n">cosine</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                   <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                   <span class="n">c</span><span class="o">=</span><span class="n">moons_mixup_sample_close_crisp</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>
                   <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span>
                   <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                   <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
                   <span class="n">s</span><span class="o">=</span><span class="mi">100</span> <span class="o">*</span> <span class="n">dist</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/d0/9mvcgn8503s6975cz1p09rmc0000gn/T/ipykernel_68128/2879942533.py:85: UserWarning: You passed a edgecolor/edgecolors (&#39;b&#39;) for an unfilled marker (&#39;x&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  axs[0].scatter(moons_mixup_sample_close[indices, 0],
/var/folders/d0/9mvcgn8503s6975cz1p09rmc0000gn/T/ipykernel_68128/2879942533.py:94: UserWarning: You passed a edgecolor/edgecolors (&#39;b&#39;) for an unfilled marker (&#39;x&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  axs[1].scatter(moons_mixup_sample_close[indices, 0],
/var/folders/d0/9mvcgn8503s6975cz1p09rmc0000gn/T/ipykernel_68128/2879942533.py:103: UserWarning: You passed a edgecolor/edgecolors (&#39;b&#39;) for an unfilled marker (&#39;x&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  axs[2].scatter(moons_mixup_sample_close[indices, 0],
</pre></div>
</div>
<img alt="../../../_images/explanation_generation_58_1.png" src="../../../_images/explanation_generation_58_1.png" />
</div>
</div>
<p>Since we are using the discrete space (hyper-rectangles) to compute distances,
all of the points within a single partition have the same distance from
the explained instance.
The ones in the explained hyper-rectangle have distance <span class="math notranslate nohighlight">\(0\)</span>, hence they are not
plotted.
Let’s kernelise these distances.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">manhattan_k_100</span> <span class="o">=</span> <span class="n">fatf_kernels</span><span class="o">.</span><span class="n">exponential_kernel</span><span class="p">(</span>
    <span class="n">manhattan</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">manhattan_k_010</span> <span class="o">=</span> <span class="n">fatf_kernels</span><span class="o">.</span><span class="n">exponential_kernel</span><span class="p">(</span>
    <span class="n">manhattan</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">manhattan_k_001</span> <span class="o">=</span> <span class="n">fatf_kernels</span><span class="o">.</span><span class="n">exponential_kernel</span><span class="p">(</span>
    <span class="n">manhattan</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">manhattan_k</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="n">manhattan_k_100</span><span class="p">,</span>
    <span class="s1">&#39;0.1&#39;</span><span class="p">:</span> <span class="n">manhattan_k_010</span><span class="p">,</span>
    <span class="s1">&#39;0.01&#39;</span><span class="p">:</span> <span class="n">manhattan_k_001</span>
<span class="p">}</span>

<span class="n">euclidean_k_100</span> <span class="o">=</span> <span class="n">fatf_kernels</span><span class="o">.</span><span class="n">exponential_kernel</span><span class="p">(</span>
    <span class="n">euclidean</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">euclidean_k_010</span> <span class="o">=</span> <span class="n">fatf_kernels</span><span class="o">.</span><span class="n">exponential_kernel</span><span class="p">(</span>
    <span class="n">euclidean</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">euclidean_k_001</span> <span class="o">=</span> <span class="n">fatf_kernels</span><span class="o">.</span><span class="n">exponential_kernel</span><span class="p">(</span>
    <span class="n">euclidean</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">.01</span><span class="p">)</span>
<span class="n">euclidean_k</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="n">euclidean_k_100</span><span class="p">,</span>
    <span class="s1">&#39;0.1&#39;</span><span class="p">:</span> <span class="n">euclidean_k_010</span><span class="p">,</span>
    <span class="s1">&#39;0.01&#39;</span><span class="p">:</span> <span class="n">euclidean_k_001</span>
<span class="p">}</span>

<span class="n">cosine_k_100</span> <span class="o">=</span> <span class="n">fatf_kernels</span><span class="o">.</span><span class="n">exponential_kernel</span><span class="p">(</span>
    <span class="n">cosine</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">cosine_k_010</span> <span class="o">=</span> <span class="n">fatf_kernels</span><span class="o">.</span><span class="n">exponential_kernel</span><span class="p">(</span>
    <span class="n">cosine</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">cosine_k_001</span> <span class="o">=</span> <span class="n">fatf_kernels</span><span class="o">.</span><span class="n">exponential_kernel</span><span class="p">(</span>
    <span class="n">cosine</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">.01</span><span class="p">)</span>
<span class="n">cosine_k</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="n">cosine_k_100</span><span class="p">,</span>
    <span class="s1">&#39;0.1&#39;</span><span class="p">:</span> <span class="n">cosine_k_010</span><span class="p">,</span>
    <span class="s1">&#39;0.01&#39;</span><span class="p">:</span> <span class="n">cosine_k_001</span>
<span class="p">}</span>

<span class="n">names_k</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;0.1&#39;</span><span class="p">,</span> <span class="s1">&#39;0.01&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ay</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">moons_X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">moons_X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">moons_y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Manhattan&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Euclidean&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Cosine&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names_k</span><span class="p">):</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;k=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="c1"># Plot x-axis quartiles</span>
<span class="n">x_quartiles_m</span> <span class="o">=</span> <span class="n">q_discretiser_moons</span><span class="o">.</span><span class="n">feature_bin_boundaries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x_quartiles_m</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ay</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="c1"># Plot y-axis quartiles</span>
<span class="n">y_quartiles_m</span> <span class="o">=</span> <span class="n">q_discretiser_moons</span><span class="o">.</span><span class="n">feature_bin_boundaries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">y_quartiles_m</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ay</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="p">[</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="c1"># Plot binarisation of the x-axis</span>
<span class="n">hyper_rectangle_m_x</span> <span class="o">=</span> <span class="n">moons_boundary_point_q_discrete</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">hyper_rectangle_m_x</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_x_min</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_x_max</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_x_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
    <span class="n">hyper_rectangle_m_x_max</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_x</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_x_min</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_x_max</span> <span class="o">=</span> <span class="mf">1.1</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ay</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span>
            <span class="n">hyper_rectangle_m_x_min</span><span class="p">,</span>
            <span class="n">hyper_rectangle_m_x_max</span><span class="p">,</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="c1"># Plot binarisation of the y-axis</span>
<span class="n">hyper_rectangle_m_y</span> <span class="o">=</span> <span class="n">moons_boundary_point_q_discrete</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">hyper_rectangle_m_y</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_y_min</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_y_max</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_y_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
    <span class="n">hyper_rectangle_m_y_max</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_y</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_y_min</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_y_max</span> <span class="o">=</span> <span class="mf">1.1</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ay</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">]</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span>
            <span class="n">hyper_rectangle_m_y_min</span><span class="p">,</span>
            <span class="n">hyper_rectangle_m_y_max</span><span class="p">,</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="c1"># Plot data using a unique marker for each binary encoding</span>
<span class="n">moons_unique_binary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">moons_mixup_sample_close_q_binary</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="n">moons_unique_binary</span><span class="p">:</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">xml_book</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">get_hyperrectangle_indices</span><span class="p">(</span>
        <span class="n">moons_mixup_sample_close_q_binary</span><span class="p">,</span> <span class="n">rep</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]):</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;v&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span>

    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names_k</span><span class="p">):</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="n">manhattan_k</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">c</span><span class="o">=</span><span class="n">moons_mixup_sample_close_crisp</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
            <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">200</span> <span class="o">*</span> <span class="n">sim</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names_k</span><span class="p">):</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="n">euclidean_k</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">c</span><span class="o">=</span><span class="n">moons_mixup_sample_close_crisp</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
            <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">200</span> <span class="o">*</span> <span class="n">sim</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names_k</span><span class="p">):</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="n">cosine_k</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">c</span><span class="o">=</span><span class="n">moons_mixup_sample_close_crisp</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
            <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">200</span> <span class="o">*</span> <span class="n">sim</span><span class="p">)</span>

<span class="c1"># Plot explained instance</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ay</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">moons_boundary_point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">moons_boundary_point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Boundary Point&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/d0/9mvcgn8503s6975cz1p09rmc0000gn/T/ipykernel_68128/3304955845.py:90: UserWarning: You passed a edgecolor/edgecolors (&#39;b&#39;) for an unfilled marker (&#39;x&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  axs[ax, 0].scatter(
/var/folders/d0/9mvcgn8503s6975cz1p09rmc0000gn/T/ipykernel_68128/3304955845.py:101: UserWarning: You passed a edgecolor/edgecolors (&#39;b&#39;) for an unfilled marker (&#39;x&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  axs[ax, 1].scatter(
/var/folders/d0/9mvcgn8503s6975cz1p09rmc0000gn/T/ipykernel_68128/3304955845.py:112: UserWarning: You passed a edgecolor/edgecolors (&#39;b&#39;) for an unfilled marker (&#39;x&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  axs[ax, 2].scatter(
</pre></div>
</div>
<img alt="../../../_images/explanation_generation_61_1.png" src="../../../_images/explanation_generation_61_1.png" />
</div>
</div>
<p>Weighting in the discrete domain shows quite a peculiar behaviour which may,
or may not, be desired.</p>
</section>
<section id="binarised-data-domain">
<h5>Binarised Data Domain<a class="headerlink" href="#binarised-data-domain" title="Permalink to this headline">¶</a></h5>
<p>Finally, let’s do the same for distances and weights computed in the binary
domain based on quartiles.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">manhattan</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">pairwise</span><span class="o">.</span><span class="n">manhattan_distances</span><span class="p">(</span>
    <span class="p">[</span><span class="n">moons_boundary_point_q_binary</span><span class="p">],</span> <span class="n">moons_mixup_sample_close_q_binary</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">euclidean</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">pairwise</span><span class="o">.</span><span class="n">euclidean_distances</span><span class="p">(</span>
    <span class="p">[</span><span class="n">moons_boundary_point_q_binary</span><span class="p">],</span> <span class="n">moons_mixup_sample_close_q_binary</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">cosine</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">pairwise</span><span class="o">.</span><span class="n">cosine_distances</span><span class="p">(</span>
    <span class="p">[</span><span class="n">moons_boundary_point_q_binary</span><span class="p">],</span> <span class="n">moons_mixup_sample_close_q_binary</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">moons_X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">moons_X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">moons_y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Manhattan&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Euclidean&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Cosine&#39;</span><span class="p">)</span>

<span class="c1"># Plot explained instance</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">moons_boundary_point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">moons_boundary_point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Boundary Point&#39;</span><span class="p">)</span>

<span class="c1"># Plot x-axis quartiles</span>
<span class="n">x_quartiles_m</span> <span class="o">=</span> <span class="n">q_discretiser_moons</span><span class="o">.</span><span class="n">feature_bin_boundaries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x_quartiles_m</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="c1"># Plot y-axis quartiles</span>
<span class="n">y_quartiles_m</span> <span class="o">=</span> <span class="n">q_discretiser_moons</span><span class="o">.</span><span class="n">feature_bin_boundaries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">y_quartiles_m</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="c1"># Plot binarisation of the x-axis</span>
<span class="n">hyper_rectangle_m_x</span> <span class="o">=</span> <span class="n">moons_boundary_point_q_discrete</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">hyper_rectangle_m_x</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_x_min</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_x_max</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_x_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
    <span class="n">hyper_rectangle_m_x_max</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_x</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_x_min</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_x_max</span> <span class="o">=</span> <span class="mf">1.1</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span>
        <span class="n">hyper_rectangle_m_x_min</span><span class="p">,</span>
        <span class="n">hyper_rectangle_m_x_max</span><span class="p">,</span>
        <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="c1"># Plot binarisation of the y-axis</span>
<span class="n">hyper_rectangle_m_y</span> <span class="o">=</span> <span class="n">moons_boundary_point_q_discrete</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">hyper_rectangle_m_y</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_y_min</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_y_max</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_y_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
    <span class="n">hyper_rectangle_m_y_max</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_y</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_y_min</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_y_max</span> <span class="o">=</span> <span class="mf">1.1</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span>
        <span class="n">hyper_rectangle_m_y_min</span><span class="p">,</span>
        <span class="n">hyper_rectangle_m_y_max</span><span class="p">,</span>
        <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="c1"># Plot data using a unique marker for each binary encoding</span>
<span class="n">moons_unique_binary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">moons_mixup_sample_close_q_binary</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="n">moons_unique_binary</span><span class="p">:</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">xml_book</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">get_hyperrectangle_indices</span><span class="p">(</span>
        <span class="n">moons_mixup_sample_close_q_binary</span><span class="p">,</span> <span class="n">rep</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]):</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;v&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span>

    <span class="n">dist</span> <span class="o">=</span> <span class="n">manhattan</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                   <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                   <span class="n">c</span><span class="o">=</span><span class="n">moons_mixup_sample_close_crisp</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>
                   <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span>
                   <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                   <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
                   <span class="n">s</span><span class="o">=</span><span class="mi">100</span> <span class="o">*</span> <span class="n">dist</span><span class="p">)</span>

    <span class="n">dist</span> <span class="o">=</span> <span class="n">euclidean</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                   <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                   <span class="n">c</span><span class="o">=</span><span class="n">moons_mixup_sample_close_crisp</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>
                   <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span>
                   <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                   <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
                   <span class="n">s</span><span class="o">=</span><span class="mi">100</span> <span class="o">*</span> <span class="n">dist</span><span class="p">)</span>

    <span class="n">dist</span> <span class="o">=</span> <span class="n">cosine</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                   <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                   <span class="n">c</span><span class="o">=</span><span class="n">moons_mixup_sample_close_crisp</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>
                   <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span>
                   <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                   <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
                   <span class="n">s</span><span class="o">=</span><span class="mi">100</span> <span class="o">*</span> <span class="n">dist</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/d0/9mvcgn8503s6975cz1p09rmc0000gn/T/ipykernel_68128/2879942533.py:85: UserWarning: You passed a edgecolor/edgecolors (&#39;b&#39;) for an unfilled marker (&#39;x&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  axs[0].scatter(moons_mixup_sample_close[indices, 0],
/var/folders/d0/9mvcgn8503s6975cz1p09rmc0000gn/T/ipykernel_68128/2879942533.py:94: UserWarning: You passed a edgecolor/edgecolors (&#39;b&#39;) for an unfilled marker (&#39;x&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  axs[1].scatter(moons_mixup_sample_close[indices, 0],
/var/folders/d0/9mvcgn8503s6975cz1p09rmc0000gn/T/ipykernel_68128/2879942533.py:103: UserWarning: You passed a edgecolor/edgecolors (&#39;b&#39;) for an unfilled marker (&#39;x&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  axs[2].scatter(moons_mixup_sample_close[indices, 0],
</pre></div>
</div>
<img alt="../../../_images/explanation_generation_65_1.png" src="../../../_images/explanation_generation_65_1.png" />
</div>
</div>
<p>Since we are using the binary space (unique background shadings) to compute
distances, all of the points within a region shaded in a given colour
have the same distance from the explained instance.
Importantly, the samples in the blue-yellow region (hyper-rectangle with the green star)
have the same binary encoding as the explained instance – their distance
is 0 – therefore none of the sampled points in that region is visible.
Let’s kernelise these distances.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">manhattan_k_100</span> <span class="o">=</span> <span class="n">fatf_kernels</span><span class="o">.</span><span class="n">exponential_kernel</span><span class="p">(</span>
    <span class="n">manhattan</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">manhattan_k_010</span> <span class="o">=</span> <span class="n">fatf_kernels</span><span class="o">.</span><span class="n">exponential_kernel</span><span class="p">(</span>
    <span class="n">manhattan</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">manhattan_k_001</span> <span class="o">=</span> <span class="n">fatf_kernels</span><span class="o">.</span><span class="n">exponential_kernel</span><span class="p">(</span>
    <span class="n">manhattan</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">manhattan_k</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="n">manhattan_k_100</span><span class="p">,</span>
    <span class="s1">&#39;0.1&#39;</span><span class="p">:</span> <span class="n">manhattan_k_010</span><span class="p">,</span>
    <span class="s1">&#39;0.01&#39;</span><span class="p">:</span> <span class="n">manhattan_k_001</span>
<span class="p">}</span>

<span class="n">euclidean_k_100</span> <span class="o">=</span> <span class="n">fatf_kernels</span><span class="o">.</span><span class="n">exponential_kernel</span><span class="p">(</span>
    <span class="n">euclidean</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">euclidean_k_010</span> <span class="o">=</span> <span class="n">fatf_kernels</span><span class="o">.</span><span class="n">exponential_kernel</span><span class="p">(</span>
    <span class="n">euclidean</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">euclidean_k_001</span> <span class="o">=</span> <span class="n">fatf_kernels</span><span class="o">.</span><span class="n">exponential_kernel</span><span class="p">(</span>
    <span class="n">euclidean</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">.01</span><span class="p">)</span>
<span class="n">euclidean_k</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="n">euclidean_k_100</span><span class="p">,</span>
    <span class="s1">&#39;0.1&#39;</span><span class="p">:</span> <span class="n">euclidean_k_010</span><span class="p">,</span>
    <span class="s1">&#39;0.01&#39;</span><span class="p">:</span> <span class="n">euclidean_k_001</span>
<span class="p">}</span>

<span class="n">cosine_k_100</span> <span class="o">=</span> <span class="n">fatf_kernels</span><span class="o">.</span><span class="n">exponential_kernel</span><span class="p">(</span>
    <span class="n">cosine</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">cosine_k_010</span> <span class="o">=</span> <span class="n">fatf_kernels</span><span class="o">.</span><span class="n">exponential_kernel</span><span class="p">(</span>
    <span class="n">cosine</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">cosine_k_001</span> <span class="o">=</span> <span class="n">fatf_kernels</span><span class="o">.</span><span class="n">exponential_kernel</span><span class="p">(</span>
    <span class="n">cosine</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">.01</span><span class="p">)</span>
<span class="n">cosine_k</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="n">cosine_k_100</span><span class="p">,</span>
    <span class="s1">&#39;0.1&#39;</span><span class="p">:</span> <span class="n">cosine_k_010</span><span class="p">,</span>
    <span class="s1">&#39;0.01&#39;</span><span class="p">:</span> <span class="n">cosine_k_001</span>
<span class="p">}</span>

<span class="n">names_k</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;0.1&#39;</span><span class="p">,</span> <span class="s1">&#39;0.01&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ay</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">moons_X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">moons_X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">moons_y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Manhattan&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Euclidean&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Cosine&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names_k</span><span class="p">):</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;k=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="c1"># Plot x-axis quartiles</span>
<span class="n">x_quartiles_m</span> <span class="o">=</span> <span class="n">q_discretiser_moons</span><span class="o">.</span><span class="n">feature_bin_boundaries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x_quartiles_m</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ay</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="c1"># Plot y-axis quartiles</span>
<span class="n">y_quartiles_m</span> <span class="o">=</span> <span class="n">q_discretiser_moons</span><span class="o">.</span><span class="n">feature_bin_boundaries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">y_quartiles_m</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ay</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="p">[</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="c1"># Plot binarisation of the x-axis</span>
<span class="n">hyper_rectangle_m_x</span> <span class="o">=</span> <span class="n">moons_boundary_point_q_discrete</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">hyper_rectangle_m_x</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_x_min</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_x_max</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_x_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
    <span class="n">hyper_rectangle_m_x_max</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_x</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_x_min</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_x_max</span> <span class="o">=</span> <span class="mf">1.1</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ay</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span>
            <span class="n">hyper_rectangle_m_x_min</span><span class="p">,</span>
            <span class="n">hyper_rectangle_m_x_max</span><span class="p">,</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="c1"># Plot binarisation of the y-axis</span>
<span class="n">hyper_rectangle_m_y</span> <span class="o">=</span> <span class="n">moons_boundary_point_q_discrete</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">hyper_rectangle_m_y</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_y_min</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_y_max</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_y_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
    <span class="n">hyper_rectangle_m_y_max</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_y</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_y_min</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_y_max</span> <span class="o">=</span> <span class="mf">1.1</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ay</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">]</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span>
            <span class="n">hyper_rectangle_m_y_min</span><span class="p">,</span>
            <span class="n">hyper_rectangle_m_y_max</span><span class="p">,</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="c1"># Plot data using a unique marker for each binary encoding</span>
<span class="n">moons_unique_binary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">moons_mixup_sample_close_q_binary</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="n">moons_unique_binary</span><span class="p">:</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">xml_book</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">get_hyperrectangle_indices</span><span class="p">(</span>
        <span class="n">moons_mixup_sample_close_q_binary</span><span class="p">,</span> <span class="n">rep</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]):</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;v&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span>

    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names_k</span><span class="p">):</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="n">manhattan_k</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">c</span><span class="o">=</span><span class="n">moons_mixup_sample_close_crisp</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
            <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">200</span> <span class="o">*</span> <span class="n">sim</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names_k</span><span class="p">):</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="n">euclidean_k</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">c</span><span class="o">=</span><span class="n">moons_mixup_sample_close_crisp</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
            <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">200</span> <span class="o">*</span> <span class="n">sim</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names_k</span><span class="p">):</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="n">cosine_k</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">c</span><span class="o">=</span><span class="n">moons_mixup_sample_close_crisp</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
            <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">200</span> <span class="o">*</span> <span class="n">sim</span><span class="p">)</span>

<span class="c1"># Plot explained instance</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ay</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">moons_boundary_point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">moons_boundary_point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Boundary Point&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/d0/9mvcgn8503s6975cz1p09rmc0000gn/T/ipykernel_68128/3304955845.py:90: UserWarning: You passed a edgecolor/edgecolors (&#39;b&#39;) for an unfilled marker (&#39;x&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  axs[ax, 0].scatter(
/var/folders/d0/9mvcgn8503s6975cz1p09rmc0000gn/T/ipykernel_68128/3304955845.py:101: UserWarning: You passed a edgecolor/edgecolors (&#39;b&#39;) for an unfilled marker (&#39;x&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  axs[ax, 1].scatter(
/var/folders/d0/9mvcgn8503s6975cz1p09rmc0000gn/T/ipykernel_68128/3304955845.py:112: UserWarning: You passed a edgecolor/edgecolors (&#39;b&#39;) for an unfilled marker (&#39;x&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  axs[ax, 2].scatter(
</pre></div>
</div>
<img alt="../../../_images/explanation_generation_68_1.png" src="../../../_images/explanation_generation_68_1.png" />
</div>
</div>
<p>While computing the distances in each representation may have its advantages
and a clear motivation based on a particular use case, the most intuitive
behaviour comes from applying this procedure to the original data domain.</p>
</section>
</section>
<section id="explanation-sparsity">
<h4>Explanation Sparsity<a class="headerlink" href="#explanation-sparsity" title="Permalink to this headline">¶</a></h4>
<p>After deciding on the weighting strategy for the sampled instances,
the next step is to reduce the number of interpretable features
used to convey the explanation.
This may be required when the data set has a large number of
features.
We will discuss usefulness of this procedure in the next section
when talking about fitting a local linear surrogate model to
binary interpretable representations.
Contrarily, tree-based interpretable representations
(not modelled with a linear surrogate) do not require
“complexity” reduction in post-processing since they have built-in
pruning mechanisms that help to improve sparsity of their
explanations.</p>
<hr class="docutils" />
<p>Let’s first select one (out of two) binary interpretable features from the
binarisation of the quartile-based discretisation.
Next, we will select one (out of three) one-hot encoded features generated with
the tree-based discretisation (since we will later model this representation
with a linear surrogate).</p>
<p>As an exercise, let’s select one feature with three different methods:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://fat-forensics.org/generated/fatf.utils.data.feature_selection.sklearn.lasso_path.html">lasso path</a>;</p></li>
<li><p><a class="reference external" href="https://fat-forensics.org/generated/fatf.utils.data.feature_selection.sklearn.forward_selection.html">forward selection</a>; and</p></li>
<li><p><a class="reference external" href="https://fat-forensics.org/generated/fatf.utils.data.feature_selection.sklearn.highest_weights.html">highest weights</a>.</p></li>
</ul>
<p>By following the links you can read more about each approach in the
API documentation of FAT Forensics.</p>
<blockquote>
<div><p>Since we want to reduce the number of interpretable features, we will
apply these functions to the binary representation created with
quartile discretisation.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">selection_lasso</span> <span class="o">=</span> <span class="n">fatf_feature_selection_skl</span><span class="o">.</span><span class="n">lasso_path</span><span class="p">(</span>
    <span class="n">moons_mixup_sample_close_q_binary</span><span class="p">,</span>
    <span class="n">moons_mixup_sample_close_crisp</span><span class="p">,</span>
    <span class="n">features_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">selection_forward</span> <span class="o">=</span> <span class="n">fatf_feature_selection_skl</span><span class="o">.</span><span class="n">forward_selection</span><span class="p">(</span>
    <span class="n">moons_mixup_sample_close_q_binary</span><span class="p">,</span>
    <span class="n">moons_mixup_sample_close_crisp</span><span class="p">,</span>
    <span class="n">features_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">selection_highest</span> <span class="o">=</span> <span class="n">fatf_feature_selection_skl</span><span class="o">.</span><span class="n">highest_weights</span><span class="p">(</span>
    <span class="n">moons_mixup_sample_close_q_binary</span><span class="p">,</span>
    <span class="n">moons_mixup_sample_close_crisp</span><span class="p">,</span>
    <span class="n">features_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*Lasso Path* feature chosen for quartiles: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">selection_lasso</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*Forward Selection* feature chosen for quartiles: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">selection_forward</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*Highest Weights* feature chosen for quartiles: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">selection_highest</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>*Lasso Path* feature chosen for quartiles: [1]
*Forward Selection* feature chosen for quartiles: [1]
*Highest Weights* feature chosen for quartiles: [1]
</pre></div>
</div>
</div>
</div>
<p>This means that all of the methods chose the <strong>second</strong> binary interpretable
feature (based on quartiles) as the most important, namely:
<span class="math notranslate nohighlight">\(0.54 &lt; x_2 \leq 0.67\)</span>.
(<strong>Index 0 corresponds to the first feature, and index 1 to the second.</strong>)</p>
<p>Let’s re-plot the quartile partition and binarisation to better understand
these results.
Intuitively, <span class="math notranslate nohighlight">\(0.54 &lt; x_2 \leq 0.67\)</span> was selected over <span class="math notranslate nohighlight">\(0.31 &lt; x_1 \leq 0.47\)</span>
as moving outside of the <em>blue&amp;yellow</em> region into the <em>blue</em> (<span class="math notranslate nohighlight">\(x_2\)</span>) region
is “more likely” to change the prediction of our explained instance than
doing the same for the <em>yellow</em> (<span class="math notranslate nohighlight">\(x_1\)</span>) region.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">moons_X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">moons_X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">moons_y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="c1"># Plot data using a unique marker for each binary encoding</span>
<span class="n">moons_unique_binary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">moons_mixup_sample_close_q_binary</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="n">moons_unique_binary</span><span class="p">:</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">xml_book</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">get_hyperrectangle_indices</span><span class="p">(</span>
        <span class="n">moons_mixup_sample_close_q_binary</span><span class="p">,</span> <span class="n">rep</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]):</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;v&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">c</span><span class="o">=</span><span class="n">moons_mixup_sample_close_crisp</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="c1"># Plot explained instance</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">moons_boundary_point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">moons_boundary_point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Boundary Point&#39;</span><span class="p">)</span>

<span class="c1"># Plot x-axis quartiles</span>
<span class="n">x_quartiles_m</span> <span class="o">=</span> <span class="n">q_discretiser_moons</span><span class="o">.</span><span class="n">feature_bin_boundaries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x_quartiles_m</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="c1"># Plot y-axis quartiles</span>
<span class="n">y_quartiles_m</span> <span class="o">=</span> <span class="n">q_discretiser_moons</span><span class="o">.</span><span class="n">feature_bin_boundaries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">y_quartiles_m</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="c1"># Plot binarisation of the x-axis</span>
<span class="n">hyper_rectangle_m_x</span> <span class="o">=</span> <span class="n">moons_boundary_point_q_discrete</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">hyper_rectangle_m_x</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_x_min</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_x_max</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_x_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
    <span class="n">hyper_rectangle_m_x_max</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_x</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_x_min</span> <span class="o">=</span> <span class="n">x_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_x_max</span> <span class="o">=</span> <span class="mf">1.1</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">hyper_rectangle_m_x_min</span><span class="p">,</span> <span class="n">hyper_rectangle_m_x_max</span><span class="p">,</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="c1"># Plot binarisation of the y-axis</span>
<span class="n">hyper_rectangle_m_y</span> <span class="o">=</span> <span class="n">moons_boundary_point_q_discrete</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">hyper_rectangle_m_y</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_y_min</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_y_max</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_y_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
    <span class="n">hyper_rectangle_m_y_max</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">hyper_rectangle_m_y</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">hyper_rectangle_m_y_min</span> <span class="o">=</span> <span class="n">y_quartiles_m</span><span class="p">[</span><span class="n">hyper_rectangle_m_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hyper_rectangle_m_y_max</span> <span class="o">=</span> <span class="mf">1.1</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span><span class="n">hyper_rectangle_m_y_min</span><span class="p">,</span> <span class="n">hyper_rectangle_m_y_max</span><span class="p">,</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/d0/9mvcgn8503s6975cz1p09rmc0000gn/T/ipykernel_68128/2530916095.py:25: UserWarning: You passed a edgecolor/edgecolors (&#39;b&#39;) for an unfilled marker (&#39;x&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  plt.scatter(moons_mixup_sample_close[indices, 0],
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.patches.Polygon at 0x11b7adee0&gt;
</pre></div>
</div>
<img alt="../../../_images/explanation_generation_75_2.png" src="../../../_images/explanation_generation_75_2.png" />
</div>
</div>
<p>Let’s move on to the tree.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">selection_lasso</span> <span class="o">=</span> <span class="n">fatf_feature_selection_skl</span><span class="o">.</span><span class="n">lasso_path</span><span class="p">(</span>
    <span class="n">moons_mixup_sample_close_tree_binary</span><span class="p">,</span>
    <span class="n">moons_mixup_sample_close_crisp</span><span class="p">,</span>
    <span class="n">features_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">selection_forward</span> <span class="o">=</span> <span class="n">fatf_feature_selection_skl</span><span class="o">.</span><span class="n">forward_selection</span><span class="p">(</span>
    <span class="n">moons_mixup_sample_close_tree_binary</span><span class="p">,</span>
    <span class="n">moons_mixup_sample_close_crisp</span><span class="p">,</span>
    <span class="n">features_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">selection_highest</span> <span class="o">=</span> <span class="n">fatf_feature_selection_skl</span><span class="o">.</span><span class="n">highest_weights</span><span class="p">(</span>
    <span class="n">moons_mixup_sample_close_tree_binary</span><span class="p">,</span>
    <span class="n">moons_mixup_sample_close_crisp</span><span class="p">,</span>
    <span class="n">features_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*Lasso Path* feature chosen for one-hot tree: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">selection_lasso</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*Forward Selection* feature chosen for one-hot tree: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">selection_forward</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*Highest Weights* feature chosen for one-hot tree: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">selection_highest</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>*Lasso Path* feature chosen for one-hot tree: [2]
*Forward Selection* feature chosen for one-hot tree: [2]
*Highest Weights* feature chosen for one-hot tree: [2]
</pre></div>
</div>
</div>
</div>
<p>These one-hot encoded indices need to be translated into tree node IDs
before becoming readable.
We execute a similar procedure to generating one-hot encoding of the
explained instance for tree discretisations, which we discussed above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">moons_mixup_sample_close_tree_discrete</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([2, 3, 4])
</pre></div>
</div>
</div>
</div>
<p>Therefore, the most important partition of the feature space is encoded
by the tree node <strong>#4</strong> (item under the 2nd index in the array above).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">plot_tree</span><span class="p">(</span>
    <span class="n">tree_binariser_moons</span><span class="p">,</span>
    <span class="n">node_ids</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">class_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">],</span>
    <span class="n">rounded</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">filled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/explanation_generation_82_0.png" src="../../../_images/explanation_generation_82_0.png" />
</div>
</div>
<p>This means that all of the methods chose partition:
<span class="math notranslate nohighlight">\(x_2 \leq 0.55 \;\; \land \;\; x_1 &gt; 0.31\)</span>.</p>
<p>This is reasonable since this partition cleanly separates the explained
instance from the grey class and
the upper partition is mostly populated by instances with identical class
predictions.
Let’s re-plot the tree partition to better understand this result.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>

<span class="c1"># Compute the decision boundary of the tree</span>
<span class="n">x_y_step</span> <span class="o">=</span> <span class="mf">0.005</span>
<span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span>
<span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span>
<span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">x_y_step</span><span class="p">),</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">x_y_step</span><span class="p">))</span>

<span class="n">Z</span> <span class="o">=</span> <span class="n">tree_binariser_moons</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span>

<span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">Z_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">Z</span><span class="p">)):</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">Z</span> <span class="o">==</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">Z_norm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

<span class="c1"># Plot the boundary</span>
<span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">Z_norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">tab20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="c1"># Plot data</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">moons_X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">moons_X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">moons_y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="c1"># Plot explained instance</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">moons_boundary_point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">moons_boundary_point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Boundary Point&#39;</span><span class="p">)</span>

<span class="c1"># Plot data using a unique marker for each encoding</span>
<span class="n">moons_unique_binary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">moons_mixup_sample_close_tree_discrete</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">markers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="n">moons_unique_binary</span><span class="p">:</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">xml_book</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">get_hyperrectangle_indices</span><span class="p">(</span>
        <span class="n">moons_mixup_sample_close_tree_discrete</span><span class="p">,</span> <span class="n">rep</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="n">moons_boundary_point_tree_discrete</span><span class="p">):</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="n">markers</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="n">moons_mixup_sample_close</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">c</span><span class="o">=</span><span class="n">moons_mixup_sample_close_crisp</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/explanation_generation_84_0.png" src="../../../_images/explanation_generation_84_0.png" />
</div>
</div>
</section>
<section id="surrogate-model-fitting">
<h4>Surrogate Model Fitting<a class="headerlink" href="#surrogate-model-fitting" title="Permalink to this headline">¶</a></h4>
<p>Last but not least, we can fit a local surrogate model and generate an
explanation.
For this toy data set, we will <strong>skip</strong> the <em>sample weighting</em> and
the <em>selection of explainable features</em> – we will come back to them when
dealing with a larger data set, i.e., <em>Bikes Sharing</em>.
Here, we will look at three approaches:</p>
<ul class="simple">
<li><p>LIME-like explainer – fitting a sparse linear model to a binary
representation generated from a quartile-based discretisation;</p></li>
<li><p>RuleFit-like explainer – fitting a sparse linear model to a binary
representation generated from a tree-based discretisation
(one-hot encoding); and</p></li>
<li><p>tree-based explainer – fitting a local decision tree directly to
the sampled data.</p></li>
</ul>
<blockquote>
<div><p>When dealing with surrogate linear models, in both cases we are fitting
them to data that are binary, i.e., in the {0, 1} set.
Since all of the features are within the same range, the coefficients of
the model – the base of our explanations – are directly comparable.
In case the original data representation is used with a linear model,
all of the features have to be normalised to the same range (not necessarily
[0, 1]) for the weights to be comparable.</p>
</div></blockquote>
<section id="lime-like">
<h5>LIME-like<a class="headerlink" href="#lime-like" title="Permalink to this headline">¶</a></h5>
<p>The <strong>only</strong> explanation available from this explainer is the
<strong>importance</strong> of interpretable concepts composed by binarisation of
quartile-based discretisation.
In case of the data point that we chose to explain these concepts are
(see the <em>Interpretable Representation</em> notebook for more details):</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(0.31 &lt; x_1 \leq 0.47\)</span> (x-axis); and</p></li>
<li><p><span class="math notranslate nohighlight">\(0.54 &lt; x_2 \leq 0.67\)</span> (y-axis)</p></li>
</ul>
<p>since these are the feature partitions that enclose the explained instance.</p>
<p>When a (sparse) linear model is fitted to this binary representation
using black-box predictions of these points as a target, it effectively learns
how important <em>being within a given range</em> is for predicting the class
assigned by the black box to our explained instance.
Let’s compute these explanations for our data point.</p>
<hr class="docutils" />
<p>Since we are using a <em>crisp</em> black box, we need to build a target vector
for our sampled data
that encodes <span class="math notranslate nohighlight">\(1\)</span> for every prediction that is the same as the one of our
explained instance, and <span class="math notranslate nohighlight">\(0\)</span> otherwise.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">explanation_target_class</span> <span class="o">=</span> <span class="n">clf_moons_crisp</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
    <span class="p">[</span><span class="n">moons_boundary_point</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">explanation_targets</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">moons_mixup_sample_close_crisp</span> <span class="o">==</span> <span class="n">explanation_target_class</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">moons_lime_like</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">linear_model</span><span class="o">.</span><span class="n">RidgeClassifier</span><span class="p">()</span>
<span class="n">moons_lime_like</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">moons_mixup_sample_close_q_binary</span><span class="p">,</span> <span class="n">explanation_targets</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>RidgeClassifier()
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">moons_lime_like</span><span class="o">.</span><span class="n">coef_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[-0.3849263 ,  0.46096981]])
</pre></div>
</div>
</div>
</div>
<p>We can visualise this explanation as a bar plot.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;$0.31 &lt; x_1 \leq 0.47$&#39;</span><span class="p">,</span> <span class="s1">&#39;$0.54 &lt; x_2 \leq 0.67$&#39;</span><span class="p">]</span>
<span class="n">h_</span> <span class="o">=</span> <span class="n">moons_lime_like</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">c_</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;g&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;r&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">h_</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>

<span class="c1"># Plot bars</span>
<span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="n">h_</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c_</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mf">.9</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">h_</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">v</span><span class="o">+</span><span class="mf">0.02</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mf">.02</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">c_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mf">.06</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">),</span>
             <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="n">left_</span><span class="p">,</span> <span class="n">right_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">((</span><span class="n">left_</span><span class="p">,</span> <span class="mf">1.2</span><span class="o">*</span><span class="n">right_</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Red class explanation&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Red class explanation&#39;)
</pre></div>
</div>
<img alt="../../../_images/explanation_generation_91_1.png" src="../../../_images/explanation_generation_91_1.png" />
</div>
</div>
<p>Therefore, for predicting the red class in our binary representation:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(0.31 &lt; x_1 \leq 0.47\)</span> has importance of <span class="math notranslate nohighlight">\(-0.38\)</span>; and</p></li>
<li><p><span class="math notranslate nohighlight">\(0.54 &lt; x_2 \leq 0.67\)</span> has importance of <span class="math notranslate nohighlight">\(0.46\)</span>.</p></li>
</ul>
<p>The latter concept has high positive importance since going outside of the
<span class="math notranslate nohighlight">\(x_2\)</span> range that it encodes – from <em>yellow&amp;blue</em> into <em>blue</em> – is
likely to result in getting into a territory of the black box
where it predicts the grey class.
The <span class="math notranslate nohighlight">\(0.31 &lt; x_1 \leq 0.47\)</span> concept, on the other hand, has negative
importance since going outside of the <em>yellow&amp;blue</em> into the <em>yellow</em>
region is not very likely to change the black-box prediction from red to grey.</p>
</section>
<section id="rulefit-like">
<h5>RuleFit-like<a class="headerlink" href="#rulefit-like" title="Permalink to this headline">¶</a></h5>
<p>RuleFit generates a collection of diverse (and overlapping) rules by
fitting a random forest to the explained data and extracting all of
its root-to-leaf paths as separate decision rules.
The importance of each rule for predicting the class of the explained instance
can then be learnt with a sparse linear model (akin to LIME).</p>
<hr class="docutils" />
<p>Let’s compute importance of our one-hot encoded tree-based rules.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">moons_rulefit_like</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">linear_model</span><span class="o">.</span><span class="n">RidgeClassifier</span><span class="p">()</span>
<span class="n">moons_rulefit_like</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">moons_mixup_sample_close_tree_binary</span><span class="p">,</span> <span class="n">explanation_targets</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>RidgeClassifier()
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">moons_rulefit_like</span><span class="o">.</span><span class="n">coef_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 0.41335198,  0.53755804, -0.95091002]])
</pre></div>
</div>
</div>
</div>
<p>We can visulaise this explanation as a bar plot.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;$x_2 &gt; 0.55$&#39;</span><span class="p">,</span>
      <span class="s1">&#39;$x_2 </span><span class="se">\\</span><span class="s1">leq 0.55$ </span><span class="se">\n</span><span class="s1"> $x_1 </span><span class="se">\\</span><span class="s1">leq 0.31$&#39;</span><span class="p">,</span>
      <span class="s1">&#39;$x_2 </span><span class="se">\\</span><span class="s1">leq 0.55$ </span><span class="se">\n</span><span class="s1"> $x_1 &gt; 0.31$&#39;</span><span class="p">]</span>
<span class="n">h_</span> <span class="o">=</span> <span class="n">moons_rulefit_like</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">c_</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;g&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;r&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">h_</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>

<span class="c1"># Plot bars</span>
<span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="n">h_</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c_</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mf">.9</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">h_</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">v</span><span class="o">+</span><span class="mf">0.02</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mf">.02</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">c_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mf">.06</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">),</span>
             <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="n">left_</span><span class="p">,</span> <span class="n">right_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">((</span><span class="n">left_</span><span class="p">,</span> <span class="mf">1.2</span><span class="o">*</span><span class="n">right_</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Red class explanation&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Red class explanation&#39;)
</pre></div>
</div>
<img alt="../../../_images/explanation_generation_97_1.png" src="../../../_images/explanation_generation_97_1.png" />
</div>
</div>
<p>In our case:</p>
<ul class="simple">
<li><p>the first rule has <strong>0.41</strong> importance and corresponds to tree node #2 –
<span class="math notranslate nohighlight">\(x_2 &gt; 0.55\)</span>;</p></li>
<li><p>the second rule has <strong>0.54</strong> importance and corresponds to tree node #3 –
<span class="math notranslate nohighlight">\(x_2 \leq 0.55 \;\; \land \;\; x_1 \leq 0.31\)</span>; and</p></li>
<li><p>the third rule has <strong>-0.95</strong> importance and corresponds to tree node #4 –
<span class="math notranslate nohighlight">\(x_2 \leq 0.55 \;\; \land \;\; x_1 &gt; 0.31\)</span>.</p></li>
</ul>
<p>These explanations are easy to interpret and very appealing in our scenario.
The first rule has high positive importance because above the <span class="math notranslate nohighlight">\(x_2 &gt; 0.55\)</span>
threshold most of the points are predicted red by our black box.
The second rule has also high positive importance because within the region
enclosed by <span class="math notranslate nohighlight">\(x_2 \leq 0.55 \;\; \land \;\; x_1 \leq 0.31\)</span> most of the sampled
instances are also predicted red.
Finally, the last rule has high negative importance because many points
enclosed by this region – <span class="math notranslate nohighlight">\(x_2 \leq 0.55 \;\; \land \;\; x_1 &gt; 0.31\)</span> –
are predicted grey.</p>
</section>
<section id="tree-based-explainer">
<h5>Tree-based Explainer<a class="headerlink" href="#tree-based-explainer" title="Permalink to this headline">¶</a></h5>
<p>Next, we move on to our tree-based surrogate – we simply fit a tree to
our locally sampled data.</p>
<p>Such a tree can provide numerous explanations:</p>
<ul class="simple">
<li><p>feature importance;</p></li>
<li><p>logical rules extracted from root-to-leaf paths; and</p></li>
<li><p>counterfactuals extracted by parsing the tree structure.</p></li>
</ul>
<p>Let’s have a look at them.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">moons_tree_based</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">DecisionTreeClassifier</span><span class="p">(</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_leaf_nodes</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">min_impurity_decrease</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">moons_tree_based</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">moons_mixup_sample_close</span><span class="p">,</span>
    <span class="n">moons_mixup_sample_close_crisp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DecisionTreeClassifier(max_leaf_nodes=4, min_impurity_decrease=0.05,
                       random_state=42)
</pre></div>
</div>
</div>
</div>
<p>Let’s start with feature importance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">moons_tree_based</span><span class="o">.</span><span class="n">feature_importances_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.28949132, 0.71050868])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;$x_1$&#39;</span><span class="p">,</span> <span class="s1">&#39;$x_2$&#39;</span><span class="p">]</span>
<span class="n">h_</span> <span class="o">=</span> <span class="n">moons_tree_based</span><span class="o">.</span><span class="n">feature_importances_</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">c_</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;g&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;r&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">h_</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>

<span class="c1"># Plot bars</span>
<span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="n">h_</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c_</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mf">.9</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">h_</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">v</span><span class="o">+</span><span class="mf">0.02</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mf">.02</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">c_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mf">.06</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">),</span>
             <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="n">left_</span><span class="p">,</span> <span class="n">right_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">((</span><span class="n">left_</span><span class="p">,</span> <span class="mf">1.2</span><span class="o">*</span><span class="n">right_</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/explanation_generation_103_0.png" src="../../../_images/explanation_generation_103_0.png" />
</div>
</div>
<p>Let’s visualise the tree to <em>manually</em> extract the rules and counterfactuals.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">plot_tree</span><span class="p">(</span>
    <span class="n">moons_tree_based</span><span class="p">,</span>
    <span class="n">node_ids</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">class_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">],</span>
    <span class="n">rounded</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">filled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">feature_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;$x_1$&#39;</span><span class="p">,</span> <span class="s1">&#39;$x_2$&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/explanation_generation_105_0.png" src="../../../_images/explanation_generation_105_0.png" />
</div>
</div>
<p>The <strong>feature importance</strong> tells us that feature <span class="math notranslate nohighlight">\(x_2\)</span> is more than twice as
important as feature <span class="math notranslate nohighlight">\(x_1\)</span> when separating the classes of our local data
sample.
Inspecting the plot of our sample corroborates this insight – no single
split on the x-axis (feature <span class="math notranslate nohighlight">\(x_1\)</span>) can give as clean separation of
the classes as a split on they y-axis (feature <span class="math notranslate nohighlight">\(x_2\)</span>).</p>
<hr class="docutils" />
<p>Since our local surrogate tree is relatively small, we can inspect it visually.
However, in more complex cases it may not be possible or can prove relatively
difficult.
To mitigate this issue, we can extract root-to-leaf paths for a selected
class and present them to the explainee as <strong>logical rules</strong>.
For example, there are two rules for predicting the red class in the
<em>neighbourhood</em> of the explained instance:
$<span class="math notranslate nohighlight">\(
0.55 &lt; x_2 \;\; \Rightarrow \;\; \texttt{red}
\)</span><span class="math notranslate nohighlight">\(
and
\)</span><span class="math notranslate nohighlight">\(
x_2 \leq 0.55 \;\; \land \;\; x_1 \leq 0.36  \;\;
\Rightarrow \;\; \texttt{red} \; \text{.}
\)</span>$
However, the length of these rules will grow proportionally to the depth of
the surrogate tree, which may render them incomprehensible.</p>
<hr class="docutils" />
<p>Class-contrastive counterfactual statements come to a rescue.
While it is possible to extract them algorithmically from the structure of
a decision tree, in this tutorial we will do it manually by visually
inspecting tree graphs.
Our explained instance <span class="math notranslate nohighlight">\(\mathring{x} = (0.4, 0.6)\)</span> is assigned to node #2 of
the tree, which predicts the <code class="docutils literal notranslate"><span class="pre">red</span></code> class.
The only leaf predicting the opposite class (<code class="docutils literal notranslate"><span class="pre">grey</span></code>) is #4, yielding the
following counterfactual:</p>
<blockquote>
<div><p>Had the second feature of the explained data point <span class="math notranslate nohighlight">\(\mathring{x}_2 = 0.6\)</span>
been <strong>smaller or equal</strong> to <span class="math notranslate nohighlight">\(0.55\)</span>, its prediction would have changed
from <code class="docutils literal notranslate"><span class="pre">red</span></code> to <code class="docutils literal notranslate"><span class="pre">grey</span></code>.</p>
</div></blockquote>
<p>It is a very appealing and succinct explanation that clearly conveys the local
(in the neighbourhood of the explained instance) behaviour of our black box.</p>
<p>Now, let’s move on the the <em>Bikes</em> data set and see how our surrogate
explainers work for a more complex problem.</p>
</section>
</section>
</section>
</section>
<section id="bikes-data-set">
<h2><span class="section-number">1.3.2. </span>Bikes Data Set<a class="headerlink" href="#bikes-data-set" title="Permalink to this headline">¶</a></h2>
<p>When dealing with the Two Moons data set, we mostly made use of a crisp
black box.
For a change, let’s explain a probabilistic classifier trained on the Bikes
data set.
Again, we will explain an instance with three different approaches:</p>
<ul class="simple">
<li><p>LIME-like explainer – fitting a sparse linear <strong>regression</strong> to
a binary representation generated from a quartile-based discretisation and
probabilities predicted by the black box for the explained class;</p></li>
<li><p>RuleFit-like explainer – fitting a sparse linear <strong>regression</strong> to a binary
representation generated from a tree-based discretisation
(one-hot encoding) and probabilities predicted by the black box for the
explained class; and</p></li>
<li><p>tree-based explainer – fitting a local <strong>regression</strong> tree directly to
the sampled data in <em>two</em> variants:</p>
<ul>
<li><p><strong>classic</strong> (single-output) regression tree fitted to the probabilities
predicted by the black box for the explained class, and</p></li>
<li><p><strong>multi-output</strong> regression tree fitted to the probabilities
predicted by the black box for <strong>all</strong> of the class, thus
modelling class interactions
(see <a class="reference external" href="https://arxiv.org/abs/2005.01427">here</a> for more details).</p></li>
</ul>
</li>
</ul>
<section id="loading-data-and-black-boxes">
<h3>Loading Data and Black Boxes<a class="headerlink" href="#loading-data-and-black-boxes" title="Permalink to this headline">¶</a></h3>
<p>We start by loading the <em>Bikes Sharing</em> data set and
fitting two black boxes: one probabilistic and one crisp.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">bikes_train_X</span><span class="p">,</span>
 <span class="n">bikes_test_X</span><span class="p">,</span>
 <span class="n">bikes_train_y</span><span class="p">,</span>
 <span class="n">bikes_test_y</span><span class="p">,</span>
 <span class="n">bikes_feature_names</span><span class="p">,</span>
 <span class="n">bikes_target_name</span><span class="p">)</span> <span class="o">=</span> <span class="n">xml_book</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">generate_bikes</span><span class="p">(</span><span class="n">random_seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="n">bikes_target_classes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>22-Mar-21 18:34:41 fatf         INFO     Seeding RNGs using the input parameter.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>22-Mar-21 18:34:41 fatf         INFO     Seeding RNGs with 42.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clf_bikes_proba</span> <span class="o">=</span> <span class="n">xml_book</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">get_random_forest</span><span class="p">(</span>
    <span class="n">bikes_train_X</span><span class="p">,</span> <span class="n">bikes_train_y</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>22-Mar-21 18:34:45 fatf         INFO     Seeding RNGs using the input parameter.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>22-Mar-21 18:34:45 fatf         INFO     Seeding RNGs with 42.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clf_bikes_crisp</span> <span class="o">=</span> <span class="n">xml_book</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">get_svc</span><span class="p">(</span>
    <span class="n">bikes_train_X</span><span class="p">,</span> <span class="n">bikes_train_y</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>22-Mar-21 18:34:45 fatf         INFO     Seeding RNGs using the input parameter.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>22-Mar-21 18:34:45 fatf         INFO     Seeding RNGs with 42.
</pre></div>
</div>
</div>
</div>
</section>
<section id="choosing-an-instance">
<h3>Choosing an Instance<a class="headerlink" href="#choosing-an-instance" title="Permalink to this headline">¶</a></h3>
<p>Now, we choose an instance to be explained.
We opt for a data point that our probabilistic black box model is relatively
uncertain about, which is likely to indicate its closeness to a decision
boundary.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bikes_test_pred_proba</span> <span class="o">=</span> <span class="n">clf_bikes_proba</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">bikes_test_X</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">boundary_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">bikes_test_pred_proba</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">boundary_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">boundary_pred</span><span class="p">)</span>

<span class="n">bikes_boundary_point</span> <span class="o">=</span> <span class="n">bikes_test_X</span><span class="p">[</span><span class="n">boundary_index</span><span class="p">,</span> <span class="p">:]</span>
<span class="n">bikes_boundary_point_proba</span> <span class="o">=</span> <span class="n">bikes_test_pred_proba</span><span class="p">[</span><span class="n">boundary_index</span><span class="p">,</span> <span class="p">:]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Close Point Prediction: </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bikes_boundary_point_proba</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Close Point Prediction: [0.2        0.45097643 0.34902357].
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bikes_boundary_point_class_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">bikes_boundary_point_proba</span><span class="p">)</span>
<span class="n">bikes_boundary_point_class</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">bikes_target_classes</span><span class="p">[</span><span class="n">bikes_boundary_point_class_index</span><span class="p">])</span>

<span class="n">bikes_boundary_point_class</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;medium&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="id2">
<h3>Sampling Data<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>Having investigated how different samplers perform on this particular data set
(cf. <code class="docutils literal notranslate"><span class="pre">3-data-sampling.ipynb</span></code>), we opt for <em>Mixup</em> and we sample 1500 data
points in the original data domain.</p>
<p>Since the bikes data set contains categorical features (albeit numerically
encoded), we will use the <code class="docutils literal notranslate"><span class="pre">categorical_indices</span></code> parameter of the Mixup sampler
to ensure that values generated for these features are from within the
expected set (already existing in the data set).
For example, if a data set has an attribute that can take the values
<code class="docutils literal notranslate"><span class="pre">{0,</span> <span class="pre">1,</span> <span class="pre">2}</span></code>, only these values will be present in the sampled data.
The following features in the Bikes data set are categorical:
<code class="docutils literal notranslate"><span class="pre">['season',</span> <span class="pre">'yr',</span> <span class="pre">'mnth',</span> <span class="pre">'holiday',</span> <span class="pre">'weekday',</span> <span class="pre">'workingday',</span> <span class="pre">'weathersit']</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span> <span class="n">bikes_feature_names</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;season&#39;,
 &#39;yr&#39;,
 &#39;mnth&#39;,
 &#39;holiday&#39;,
 &#39;weekday&#39;,
 &#39;workingday&#39;,
 &#39;weathersit&#39;,
 &#39;temp&#39;,
 &#39;atemp&#39;,
 &#39;hum&#39;,
 &#39;windspeed&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bikes_categorical_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bikes_samples_number</span> <span class="o">=</span> <span class="mi">1500</span>

<span class="n">bikes_mixup_sampler</span> <span class="o">=</span> <span class="n">fatf_augmentation</span><span class="o">.</span><span class="n">Mixup</span><span class="p">(</span>
    <span class="n">bikes_test_X</span><span class="p">,</span>
    <span class="n">bikes_test_y</span><span class="p">,</span>
    <span class="n">categorical_indices</span><span class="o">=</span><span class="n">bikes_categorical_indices</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fatf</span><span class="o">.</span><span class="n">setup_random_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">bikes_mixup_sample_close</span> <span class="o">=</span> <span class="n">bikes_mixup_sampler</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
    <span class="n">bikes_boundary_point</span><span class="p">,</span>
    <span class="n">samples_number</span><span class="o">=</span><span class="n">bikes_samples_number</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>22-Mar-21 18:34:45 fatf         INFO     Seeding RNGs using the input parameter.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>22-Mar-21 18:34:45 fatf         INFO     Seeding RNGs with 42.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bikes_mixup_sample_close_crisp</span> <span class="o">=</span> <span class="n">clf_bikes_crisp</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
    <span class="n">bikes_mixup_sample_close</span><span class="p">)</span>

<span class="n">bikes_mixup_sample_close_proba</span> <span class="o">=</span> <span class="n">clf_bikes_proba</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span>
    <span class="n">bikes_mixup_sample_close</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s investigate versatility of our sample for the explained class.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bikes_mixup_sample_close_proba_ex</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">bikes_mixup_sample_close_proba</span><span class="p">[:,</span> <span class="n">bikes_boundary_point_class_index</span><span class="p">])</span>

<span class="n">v_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">bikes_mixup_sample_close_proba_ex</span><span class="p">)</span>
<span class="n">v_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bikes_mixup_sample_close_proba_ex</span><span class="p">)</span>
<span class="n">v_mse</span> <span class="o">=</span> <span class="n">xml_book</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">mse</span><span class="p">(</span><span class="n">bikes_mixup_sample_close_proba_ex</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sample min: </span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_min</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sample max: </span><span class="si">{:.3f}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_max</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sample mse: </span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_mse</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sample min: 0.024
Sample max: 0.964

Sample mse: 0.055
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bikes_mixup_sample_close_proba_ex</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/explanation_generation_126_0.png" src="../../../_images/explanation_generation_126_0.png" />
</div>
</div>
<p>The sample seems fairly diverse, let’s move on to building the explainers.</p>
</section>
<section id="lime-like-explainer">
<h3>LIME-like Explainer<a class="headerlink" href="#lime-like-explainer" title="Permalink to this headline">¶</a></h3>
<section id="interpretable-representation">
<h4>Interpretable Representation<a class="headerlink" href="#interpretable-representation" title="Permalink to this headline">¶</a></h4>
<p>Let’s start with a binary representation based on quartile discretisation.
We will apply quartile discretisation to the entire data set.
The <code class="docutils literal notranslate"><span class="pre">categorical_indices</span></code> argument ensures that only numerical features are
discretised.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bikes_q_discretiser</span> <span class="o">=</span> <span class="n">fatf_discretisation</span><span class="o">.</span><span class="n">QuartileDiscretiser</span><span class="p">(</span>
    <span class="n">bikes_test_X</span><span class="p">,</span>
    <span class="n">feature_names</span><span class="o">=</span> <span class="n">bikes_feature_names</span><span class="p">,</span>
    <span class="n">categorical_indices</span><span class="o">=</span><span class="n">bikes_categorical_indices</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bikes_mixup_sample_close_discrete</span> <span class="o">=</span> <span class="n">bikes_q_discretiser</span><span class="o">.</span><span class="n">discretise</span><span class="p">(</span>
    <span class="n">bikes_mixup_sample_close</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xml_book</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">weighted_purity</span><span class="p">(</span>
    <span class="n">bikes_mixup_sample_close_discrete</span><span class="p">,</span>
    <span class="n">bikes_mixup_sample_close_proba_ex</span><span class="p">,</span>
    <span class="s1">&#39;mse&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.014577175118340472
</pre></div>
</div>
</div>
</div>
<p>The purity has improved; let’s have a look at binarisation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bikes_boundary_point_discrete</span> <span class="o">=</span> <span class="n">bikes_q_discretiser</span><span class="o">.</span><span class="n">discretise</span><span class="p">(</span>
    <span class="n">bikes_boundary_point</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bikes_mixup_sample_close_binary</span> <span class="o">=</span> <span class="n">fatf_transformation</span><span class="o">.</span><span class="n">dataset_row_masking</span><span class="p">(</span>
    <span class="n">bikes_mixup_sample_close_discrete</span><span class="p">,</span> <span class="n">bikes_boundary_point_discrete</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bikes_boundary_point_binary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span>
    <span class="n">bikes_boundary_point_discrete</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xml_book</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">weighted_purity</span><span class="p">(</span>
    <span class="n">bikes_mixup_sample_close_binary</span><span class="p">,</span>
    <span class="n">bikes_mixup_sample_close_proba_ex</span><span class="p">,</span>
    <span class="s1">&#39;mse&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0252348851455624
</pre></div>
</div>
</div>
</div>
<p>The purity of our binary interpretable representation has seen a drastic
deterioration – the raw data sample had Mean Squared Error of 0.024,
our discretisation had 0.015, whereas the binarisation has 0.025,
which is larger than the one of the raw data.
This is not a good sign for the quality of our future explanations.
Regardless, let’s move on to the explanation generation stage.</p>
</section>
<section id="id3">
<h4>Explanation Generation<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>Since the Bikes data set has 11 features, we will apply both <em>weighting</em> of
sampled instances and <em>interpretable feature selection</em> steps.
Then, we will move on to fitting a sparse linear regression to the probabilities
of the explained class and generate an explanation.</p>
<section id="instance-weighting">
<h5>Instance Weighting<a class="headerlink" href="#instance-weighting" title="Permalink to this headline">¶</a></h5>
<p>Given a large number of categorical features in the Bikes data set,
we will use <em>Manhattan distance</em> and the exponential kernel with
width given by <span class="math notranslate nohighlight">\(0.75 \times \sqrt{\text{features number}}\)</span>
(formulation proposed by LIME).
We will compute the distance in the original feature space.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">manhattan_dist</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">pairwise</span><span class="o">.</span><span class="n">manhattan_distances</span><span class="p">(</span>
    <span class="p">[</span><span class="n">bikes_boundary_point</span><span class="p">],</span> <span class="n">bikes_mixup_sample_close</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">features_number</span> <span class="o">=</span> <span class="n">bikes_mixup_sample_close</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">kernel_width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">features_number</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.75</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">manhattan_dist_kern</span> <span class="o">=</span> <span class="n">fatf_kernels</span><span class="o">.</span><span class="n">exponential_kernel</span><span class="p">(</span>
    <span class="n">manhattan_dist</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">kernel_width</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Interpreting the distribution is not straight forward, but let’s plot
it anyway.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">manhattan_dist_kern</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/explanation_generation_145_0.png" src="../../../_images/explanation_generation_145_0.png" />
</div>
</div>
</section>
<section id="interpretable-feature-selection">
<h5>Interpretable Feature Selection<a class="headerlink" href="#interpretable-feature-selection" title="Permalink to this headline">¶</a></h5>
<p>Since we are dealing with 11 features, let’s select 4 of them to
introduce sparsity into our explanation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">selection_lasso</span> <span class="o">=</span> <span class="n">fatf_feature_selection_skl</span><span class="o">.</span><span class="n">lasso_path</span><span class="p">(</span>
    <span class="n">bikes_mixup_sample_close_binary</span><span class="p">,</span>
    <span class="n">bikes_mixup_sample_close_proba_ex</span><span class="p">,</span>
    <span class="n">features_number</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">selection_forward</span> <span class="o">=</span> <span class="n">fatf_feature_selection_skl</span><span class="o">.</span><span class="n">forward_selection</span><span class="p">(</span>
    <span class="n">bikes_mixup_sample_close_binary</span><span class="p">,</span>
    <span class="n">bikes_mixup_sample_close_proba_ex</span><span class="p">,</span>
    <span class="n">features_number</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">selection_highest</span> <span class="o">=</span> <span class="n">fatf_feature_selection_skl</span><span class="o">.</span><span class="n">highest_weights</span><span class="p">(</span>
    <span class="n">bikes_mixup_sample_close_binary</span><span class="p">,</span>
    <span class="n">bikes_mixup_sample_close_proba_ex</span><span class="p">,</span>
    <span class="n">features_number</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*Lasso Path* features chosen for quartiles: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">selection_lasso</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*Forward Selection* features chosen for quartiles: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">selection_forward</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*Highest Weights* features chosen for quartiles: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">selection_highest</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>*Lasso Path* features chosen for quartiles: [ 1  7  9 10]
*Forward Selection* features chosen for quartiles: [ 1  7  9 10]
*Highest Weights* features chosen for quartiles: [ 1  7  9 10]
</pre></div>
</div>
</div>
</div>
<p>All of the methods seem to agree – we do not need to make a call here.
Finally, let’s move on to explanation generation.</p>
</section>
<section id="id4">
<h5>Explanation Generation<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h5>
<p>We train Ridge regression on the selected subset of interpretable features
for the probabilities predicted by the black box on the sampled data
for our explained class,
using the kernelised Manhattan distances as sample weights.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bikes_lime_like</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">linear_model</span><span class="o">.</span><span class="n">Ridge</span><span class="p">()</span>
<span class="n">bikes_lime_like</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">bikes_mixup_sample_close_binary</span><span class="p">[:,</span> <span class="n">selection_lasso</span><span class="p">],</span>
    <span class="n">bikes_mixup_sample_close_proba_ex</span><span class="p">,</span>
    <span class="n">sample_weight</span><span class="o">=</span><span class="n">manhattan_dist_kern</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ridge()
</pre></div>
</div>
</div>
</div>
<p>Let’s generate the names of our interpretable features…<br />
(we extract the names of binary interpretable features for
numerical attributes (numerical bins) from the
<code class="docutils literal notranslate"><span class="pre">feature_value_names</span></code> attribute of the quartile discretiser
object, and build names of interpretable features for the
categorical attributes manually)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">interpretable_feature_names</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">feature_index</span> <span class="ow">in</span> <span class="n">selection_lasso</span><span class="p">:</span>
    <span class="n">feature_index</span> <span class="o">=</span> <span class="n">feature_index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">bin_id</span> <span class="o">=</span> <span class="n">bikes_boundary_point_discrete</span><span class="p">[</span><span class="n">feature_index</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Generate interpretable representation names of categorical attributes</span>
    <span class="k">if</span> <span class="n">feature_index</span> <span class="ow">in</span> <span class="n">bikes_categorical_indices</span><span class="p">:</span>
        <span class="n">interpretable_feature_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">bikes_feature_names</span><span class="p">[</span><span class="n">feature_index</span><span class="p">],</span> <span class="n">bin_id</span><span class="p">)</span>
    <span class="c1"># Generate interpretable representation names of numerical attributes</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">interpretable_feature_name</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">bikes_q_discretiser</span><span class="o">.</span><span class="n">feature_value_names</span><span class="p">[</span><span class="n">feature_index</span><span class="p">][</span><span class="n">bin_id</span><span class="p">])</span>

    <span class="n">interpretable_feature_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interpretable_feature_name</span><span class="p">)</span>

<span class="n">interpretable_feature_names</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;yr = 1&#39;, &#39;0.50 &lt; *temp* &lt;= 0.66&#39;, &#39;0.73 &lt; *hum*&#39;, &#39;0.23 &lt; *windspeed*&#39;]
</pre></div>
</div>
</div>
</div>
<p>…and plot the explanations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_</span> <span class="o">=</span> <span class="n">interpretable_feature_names</span>
<span class="n">h_</span> <span class="o">=</span> <span class="n">bikes_lime_like</span><span class="o">.</span><span class="n">coef_</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">c_</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;g&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;r&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">h_</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>

<span class="c1"># Plot bars</span>
<span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="n">h_</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c_</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mf">.9</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">h_</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">v</span><span class="o">+</span><span class="mf">0.02</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mf">.02</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">c_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mf">.06</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">),</span>
             <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="n">left_</span><span class="p">,</span> <span class="n">right_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">((</span><span class="n">left_</span><span class="p">,</span> <span class="mf">1.2</span><span class="o">*</span><span class="n">right_</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;*</span><span class="si">{}</span><span class="s1">* class explanation&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bikes_boundary_point_class</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;*medium* class explanation&#39;)
</pre></div>
</div>
<img alt="../../../_images/explanation_generation_155_1.png" src="../../../_images/explanation_generation_155_1.png" />
</div>
</div>
<p>Therefore, <strong>for this particular instance</strong> the <em>windspeed</em> larger than 0.23
has significant positive influence on predicting the <strong>medium</strong> class.
<em>humidity</em> larger than 0.73 also has positive effect, whereas <em>temp</em>erature
between 0.5 and 0.66 and the year being of category 1 have negative effects.
By looking at the
<a class="reference external" href="https://archive.ics.uci.edu/ml/datasets/bike+sharing+dataset">description</a>
of the Bikes data set, <span class="math notranslate nohighlight">\(yr = 1\)</span> is 2012 and the temperature is between
15.5 and 23.02 degree Celsius.</p>
</section>
</section>
</section>
<section id="rulefit-like-explainer">
<h3>RuleFit-like Explainer<a class="headerlink" href="#rulefit-like-explainer" title="Permalink to this headline">¶</a></h3>
<section id="id5">
<h4>Tree-based Interpretable Representation<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<p>We start by creating a tree-based discretisation of the feature space.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tree_binariser_bikes</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">DecisionTreeRegressor</span><span class="p">(</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">tree_binariser_bikes</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">bikes_mixup_sample_close</span><span class="p">,</span>
                         <span class="n">bikes_mixup_sample_close_proba_ex</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DecisionTreeRegressor(max_depth=3, random_state=42)
</pre></div>
</div>
</div>
</div>
<p>First, we get the discrete…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bikes_mixup_sample_close_tree_discrete</span> <span class="o">=</span> <span class="n">tree_binariser_bikes</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="n">bikes_mixup_sample_close</span><span class="p">)</span>
<span class="n">bikes_boundary_point_tree_discrete</span> <span class="o">=</span> <span class="n">tree_binariser_bikes</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="p">[</span><span class="n">bikes_boundary_point</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># scikit-learn only accepts 2-D data</span>
</pre></div>
</div>
</div>
</div>
<p>…then binary (one-hot encoded) representation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bikes_mixup_sample_close_tree_binary</span> <span class="o">=</span> <span class="n">xml_book</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">one_hot_encode</span><span class="p">(</span>
    <span class="n">bikes_mixup_sample_close_tree_discrete</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s see purity of out discretisation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xml_book</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">weighted_purity</span><span class="p">(</span>
    <span class="n">bikes_mixup_sample_close_tree_binary</span><span class="p">,</span>
    <span class="n">bikes_mixup_sample_close_proba_ex</span><span class="p">,</span>
    <span class="s1">&#39;mse&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.023009279041967014
</pre></div>
</div>
</div>
</div>
<p>We have not seen much of an improvement in the purity of our discretisation
because we limited the tree depth to 3.
This is because we need to visually inspect the tree to extract important
rules, however if this step is processed algorithmically, we can increase the
tree depth to get better quality discretisation.</p>
</section>
<section id="id6">
<h4>Explanation Generation<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bikes_rulefit_like</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">linear_model</span><span class="o">.</span><span class="n">Ridge</span><span class="p">()</span>
<span class="n">bikes_rulefit_like</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">bikes_mixup_sample_close_tree_binary</span><span class="p">,</span>
    <span class="n">bikes_mixup_sample_close_proba_ex</span><span class="p">,</span>
    <span class="n">sample_weight</span><span class="o">=</span><span class="n">manhattan_dist_kern</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ridge()
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bikes_rulefit_like</span><span class="o">.</span><span class="n">coef_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([-0.12464442,  0.1292043 ,  0.10902876, -0.33209851, -0.11180737,
        0.07220614,  0.20656718,  0.05154393])
</pre></div>
</div>
</div>
</div>
<p>Let’s find the four most significant rules.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">important_one_hot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">bikes_rulefit_like</span><span class="o">.</span><span class="n">coef_</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">important_one_hot</span> <span class="o">=</span> <span class="n">important_one_hot</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
<span class="n">important_one_hot</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([3, 6, 1, 0])
</pre></div>
</div>
</div>
</div>
<p>Let’s figure out which tree nodes they correspond to –
we repeat the same procedure as with the Two Moons data set.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">leaf_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">bikes_mixup_sample_close_tree_discrete</span><span class="p">))</span>
<span class="n">important_leaves</span> <span class="o">=</span> <span class="n">leaf_id</span><span class="p">[</span><span class="n">important_one_hot</span><span class="p">]</span>
<span class="n">important_leaves</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 7, 13,  4,  3])
</pre></div>
</div>
</div>
</div>
<p>Next, we visualise the tree to find the rules.
The value predicted by the tree is probability of the <em>middle</em> class.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">plot_tree</span><span class="p">(</span>
    <span class="n">tree_binariser_bikes</span><span class="p">,</span>
    <span class="n">node_ids</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">class_names</span><span class="o">=</span><span class="n">bikes_target_classes</span><span class="p">,</span>
    <span class="n">rounded</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">filled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">feature_names</span><span class="o">=</span><span class="n">bikes_feature_names</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/explanation_generation_175_0.png" src="../../../_images/explanation_generation_175_0.png" />
</div>
</div>
<p>We can visualise this explanation as a bar plot.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;windspeed $\leq 0.214$ </span><span class="se">\n</span><span class="s1"> temp $&gt; 0.467$ </span><span class="se">\n</span><span class="s1"> yr $=1$&#39;</span><span class="p">,</span>
      <span class="s1">&#39;windspeed $&gt; 0.214$ </span><span class="se">\n</span><span class="s1"> hum $&gt; 0.763$ </span><span class="se">\n</span><span class="s1"> windspeed $\leq 0.255$&#39;</span><span class="p">,</span>
      <span class="s1">&#39;windspeed $\leq 0.214$ </span><span class="se">\n</span><span class="s1"> temp $\leq 0.467$ </span><span class="se">\n</span><span class="s1"> hum $&gt; 0.786$&#39;</span><span class="p">,</span>
      <span class="s1">&#39;windspeed $\leq 0.214$ </span><span class="se">\n</span><span class="s1"> temp $\leq 0.467$ </span><span class="se">\n</span><span class="s1"> hum $\leq 0.786$&#39;</span><span class="p">]</span>
<span class="n">h_</span> <span class="o">=</span> <span class="n">bikes_rulefit_like</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="n">important_one_hot</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">c_</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;g&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;r&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">h_</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>

<span class="c1"># Plot bars</span>
<span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="n">h_</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c_</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mf">.9</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">h_</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">v</span><span class="o">+</span><span class="mf">0.02</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mf">.02</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">c_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mf">.06</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">),</span>
             <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="n">left_</span><span class="p">,</span> <span class="n">right_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">((</span><span class="n">left_</span><span class="p">,</span> <span class="mf">1.2</span><span class="o">*</span><span class="n">right_</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;*</span><span class="si">{}</span><span class="s1">* class explanation&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bikes_boundary_point_class</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;*medium* class explanation&#39;)
</pre></div>
</div>
<img alt="../../../_images/explanation_generation_177_1.png" src="../../../_images/explanation_generation_177_1.png" />
</div>
</div>
<p>The top two rules tell us that with <em>windspeed</em> <span class="math notranslate nohighlight">\(\leq 0.214\)</span> and <em>temperature</em>
<span class="math notranslate nohighlight">\(\leq 0.467\)</span>, the humidity is a deciding factor for predicting the <em>medium</em>
class:</p>
<ul class="simple">
<li><p><em>humidity</em> <span class="math notranslate nohighlight">\(&gt; 0.786\)</span> has positive effect on this class, and</p></li>
<li><p><em>humidity</em> <span class="math notranslate nohighlight">\(\leq 0.786\)</span> has negative effect.</p></li>
</ul>
<p>Similarly, for <em>windspeed</em> between <span class="math notranslate nohighlight">\(0.214\)</span> and <span class="math notranslate nohighlight">\(0.255\)</span>, <em>humidity</em> higher than
<span class="math notranslate nohighlight">\(0.763\)</span> has a positive effect on predicting the <em>medium</em> class.</p>
<p>The last rule tells us that for low <em>windspeed</em> (<span class="math notranslate nohighlight">\(\leq 0.214\)</span>) and high
<em>temperature</em> (<span class="math notranslate nohighlight">\(&gt; 0.467\)</span>), the year is a deciding factor.</p>
<p>While these explanations are a bit more intuitive, it is difficult to tell
whether the effect would push the prediction down to <em>low</em> or up to <em>high</em>.
Let’s see whether decision tree-based surrogates can help us with that.</p>
</section>
</section>
<section id="tree-based-local-surrogate">
<h3>Tree-based Local Surrogate<a class="headerlink" href="#tree-based-local-surrogate" title="Permalink to this headline">¶</a></h3>
<section id="single-output-regression-surrogate">
<h4>Single-output Regression Surrogate<a class="headerlink" href="#single-output-regression-surrogate" title="Permalink to this headline">¶</a></h4>
<p>Let’s start with a simple regression tree trained on the
sampled data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tree_based_surrogate_single</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">DecisionTreeRegressor</span><span class="p">(</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">tree_based_surrogate_single</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">bikes_mixup_sample_close</span><span class="p">,</span>
    <span class="n">bikes_mixup_sample_close_proba_ex</span><span class="p">,</span>
    <span class="n">sample_weight</span><span class="o">=</span><span class="n">manhattan_dist_kern</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DecisionTreeRegressor(max_depth=3, random_state=42)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tree_discretisation</span> <span class="o">=</span> <span class="n">tree_based_surrogate_single</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="n">bikes_mixup_sample_close</span><span class="p">)</span>

<span class="n">xml_book</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">weighted_purity</span><span class="p">(</span>
    <span class="n">tree_discretisation</span><span class="p">,</span>
    <span class="n">bikes_mixup_sample_close_proba_ex</span><span class="p">,</span>
    <span class="s1">&#39;mse&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.025292846388453673
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tree_based_surrogate_single</span><span class="o">.</span><span class="n">feature_importances_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.        , 0.        , 0.        , 0.        , 0.        ,
       0.        , 0.        , 0.19107699, 0.        , 0.22998904,
       0.57893397])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">important_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span>
    <span class="n">tree_based_surrogate_single</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">important_features</span> <span class="o">=</span> <span class="n">important_features</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
<span class="n">important_features</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([10,  9,  7])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">bikes_feature_names</span><span class="p">)[</span><span class="n">important_features</span><span class="p">]</span>
<span class="n">h_</span> <span class="o">=</span> <span class="n">tree_based_surrogate_single</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">[</span><span class="n">important_features</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">c_</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;g&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;r&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">h_</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>

<span class="c1"># Plot bars</span>
<span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="n">h_</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c_</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mf">.9</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">h_</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">v</span><span class="o">+</span><span class="mf">0.02</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mf">.02</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">c_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mf">.06</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">),</span>
             <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="n">left_</span><span class="p">,</span> <span class="n">right_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">((</span><span class="n">left_</span><span class="p">,</span> <span class="mf">1.2</span><span class="o">*</span><span class="n">right_</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/explanation_generation_185_0.png" src="../../../_images/explanation_generation_185_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">plot_tree</span><span class="p">(</span>
    <span class="n">tree_based_surrogate_single</span><span class="p">,</span>
    <span class="n">node_ids</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">class_names</span><span class="o">=</span><span class="n">bikes_target_classes</span><span class="p">,</span>
    <span class="n">rounded</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">filled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">feature_names</span><span class="o">=</span><span class="n">bikes_feature_names</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/explanation_generation_186_0.png" src="../../../_images/explanation_generation_186_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bikes_feature_names</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;season&#39;,
 &#39;yr&#39;,
 &#39;mnth&#39;,
 &#39;holiday&#39;,
 &#39;weekday&#39;,
 &#39;workingday&#39;,
 &#39;weathersit&#39;,
 &#39;temp&#39;,
 &#39;atemp&#39;,
 &#39;hum&#39;,
 &#39;windspeed&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bikes_boundary_point</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([3.      , 1.      , 9.      , 0.      , 6.      , 0.      ,
       2.      , 0.659167, 0.611121, 0.799167, 0.281104], dtype=float32)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tree_based_surrogate_single</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="p">[</span><span class="n">bikes_boundary_point</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>13
</pre></div>
</div>
</div>
</div>
<p>Similar to the Moons example, we can extract counterfactuals for our explained
instance.
Since it is assigned to the leaf #13, the closest leaf with low probability
of the <em>medium</em> class is #10, which gives the following counterfactual:</p>
<blockquote>
<div><p>Had the <em>humidity</em> been <span class="math notranslate nohighlight">\(\leq 0.763\)</span> instead of 0.799, and <em>windspeed</em> been
<span class="math notranslate nohighlight">\(\leq 0.271\)</span> instead of 0.281, the prediction of the <em>middle</em> class would
drop from 0.556 to 0.373.</p>
</div></blockquote>
<p>and</p>
<blockquote>
<div><p>Had the <em>humidity</em> been <span class="math notranslate nohighlight">\(&gt; 0.823\)</span> instead of 0.799, the prediction of the
<em>middle</em> class would raise from 0.556 to 0.733.</p>
</div></blockquote>
<p>However, we still don’t know what happens to the other two classes.
Let’s turn to multi-output regression trees and see how they can handle
this problem.</p>
</section>
<section id="multi-output-regression-surrogate">
<h4>Multi-output Regression Surrogate<a class="headerlink" href="#multi-output-regression-surrogate" title="Permalink to this headline">¶</a></h4>
<p>Instead of just using the probabilities predicted by the black box for the
<em>middle</em> class, we use probabilities predicted for all the classes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tree_based_surrogate_multi</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">DecisionTreeRegressor</span><span class="p">(</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">tree_based_surrogate_multi</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">bikes_mixup_sample_close</span><span class="p">,</span>
    <span class="n">bikes_mixup_sample_close_proba</span><span class="p">,</span>
    <span class="n">sample_weight</span><span class="o">=</span><span class="n">manhattan_dist_kern</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DecisionTreeRegressor(max_depth=3, random_state=42)
</pre></div>
</div>
</div>
</div>
<p>Let’s see purity of the <em>middle</em> class.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tree_discretisation</span> <span class="o">=</span> <span class="n">tree_based_surrogate_multi</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="n">bikes_mixup_sample_close</span><span class="p">)</span>

<span class="c1"># Purity of the *middle* class</span>
<span class="n">xml_book</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">weighted_purity</span><span class="p">(</span>
    <span class="n">tree_discretisation</span><span class="p">,</span>
    <span class="n">bikes_mixup_sample_close_proba_ex</span><span class="p">,</span>
    <span class="s1">&#39;mse&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.02640628492253447
</pre></div>
</div>
</div>
</div>
<p>Also, let’s have a look at purity of the <em>low</em> class…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Purity of the *low* class</span>
<span class="n">xml_book</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">weighted_purity</span><span class="p">(</span>
    <span class="n">tree_discretisation</span><span class="p">,</span>
    <span class="n">bikes_mixup_sample_close_proba</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="s1">&#39;mse&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.015252539380466468
</pre></div>
</div>
</div>
</div>
<p>…and the <em>high</em> class.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Purity of the *high* class</span>
<span class="n">xml_book</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">weighted_purity</span><span class="p">(</span>
    <span class="n">tree_discretisation</span><span class="p">,</span>
    <span class="n">bikes_mixup_sample_close_proba</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="s1">&#39;mse&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.03408769588399393
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tree_based_surrogate_multi</span><span class="o">.</span><span class="n">feature_importances_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.        , 0.        , 0.        , 0.        , 0.        ,
       0.        , 0.        , 0.03564297, 0.4555767 , 0.23755485,
       0.27122548])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">important_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span>
    <span class="n">tree_based_surrogate_multi</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">important_features</span> <span class="o">=</span> <span class="n">important_features</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
<span class="n">important_features</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 8, 10,  9,  7])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">bikes_feature_names</span><span class="p">)[</span><span class="n">important_features</span><span class="p">]</span>
<span class="n">h_</span> <span class="o">=</span> <span class="n">tree_based_surrogate_multi</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">[</span><span class="n">important_features</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">c_</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;g&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;r&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">h_</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>

<span class="c1"># Plot bars</span>
<span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="n">h_</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c_</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mf">.9</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">h_</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">v</span><span class="o">+</span><span class="mf">0.02</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mf">.02</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">c_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mf">.06</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">),</span>
             <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="n">left_</span><span class="p">,</span> <span class="n">right_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">((</span><span class="n">left_</span><span class="p">,</span> <span class="mf">1.2</span><span class="o">*</span><span class="n">right_</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/explanation_generation_201_0.png" src="../../../_images/explanation_generation_201_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">plot_tree</span><span class="p">(</span>
    <span class="n">tree_based_surrogate_multi</span><span class="p">,</span>
    <span class="n">node_ids</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">class_names</span><span class="o">=</span><span class="n">bikes_target_classes</span><span class="p">,</span>
    <span class="n">rounded</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">filled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">feature_names</span><span class="o">=</span><span class="n">bikes_feature_names</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/explanation_generation_202_0.png" src="../../../_images/explanation_generation_202_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bikes_feature_names</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;season&#39;,
 &#39;yr&#39;,
 &#39;mnth&#39;,
 &#39;holiday&#39;,
 &#39;weekday&#39;,
 &#39;workingday&#39;,
 &#39;weathersit&#39;,
 &#39;temp&#39;,
 &#39;atemp&#39;,
 &#39;hum&#39;,
 &#39;windspeed&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bikes_boundary_point</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([3.      , 1.      , 9.      , 0.      , 6.      , 0.      ,
       2.      , 0.659167, 0.611121, 0.799167, 0.281104], dtype=float32)
</pre></div>
</div>
</div>
</div>
<p>Let’s see which tree node our instance is assigned to.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tree_based_surrogate_multi</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="p">[</span><span class="n">bikes_boundary_point</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>14
</pre></div>
</div>
</div>
</div>
<p>Now, we can compose counterfactuals such as:</p>
<blockquote>
<div><p>Had the <em>humidity</em> been <span class="math notranslate nohighlight">\( \leq 0.711\)</span> instead of 0.799, the prediction would
have changed from: <strong>medium</strong> – <span class="math notranslate nohighlight">\(p(\text{medium})=0.568\)</span>, <span class="math notranslate nohighlight">\(p(\text{high})=0.295\)</span> – to
<strong>high</strong> – <span class="math notranslate nohighlight">\(p(\text{medium})=0.434\)</span>, <span class="math notranslate nohighlight">\(p(\text{high})=0.522\)</span>.</p>
</div></blockquote>
<p>or</p>
<blockquote>
<div><p>Had <em>windspeed</em> been <span class="math notranslate nohighlight">\(\leq 0.228\)</span> instead of 0.281, and <em>humidity</em> been
<span class="math notranslate nohighlight">\(\leq 0.774\)</span> instead of 0.799, the prediction would have changed from
<strong>medium</strong> – <span class="math notranslate nohighlight">\(p(\text{medium})=0.568\)</span>, <span class="math notranslate nohighlight">\(p(\text{high})=0.295\)</span> – to <strong>high</strong>
– <span class="math notranslate nohighlight">\(p(\text{medium})=0.138\)</span>, <span class="math notranslate nohighlight">\(p(\text{high})=0.797\)</span>.</p>
</div></blockquote>
<p>or</p>
<blockquote>
<div><p>Had <em>atemp</em> been <span class="math notranslate nohighlight">\(\leq 0.39\)</span> instead of 0.611, and <em>temp</em> been
<span class="math notranslate nohighlight">\(\leq 0.339\)</span> instead of 0.659, the prediction would have changed from
<strong>medium</strong> – <span class="math notranslate nohighlight">\(p(\text{medium})=0.568\)</span>, <span class="math notranslate nohighlight">\(p(\text{low})=0.137\)</span> – to <strong>low</strong>
– <span class="math notranslate nohighlight">\(p(\text{medium})=0.381\)</span>, <span class="math notranslate nohighlight">\(p(\text{low})=0.581\)</span>.
(This is tree node #2, which is not a leaf node, however by looking at the
predictions of both its children, we can safely make such a claim.)</p>
</div></blockquote>
</section>
</section>
</section>
<section id="summary">
<h2><span class="section-number">1.3.3. </span>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<section id="ready-made-explainers">
<h3>Ready-made Explainers<a class="headerlink" href="#ready-made-explainers" title="Permalink to this headline">¶</a></h3>
<p>Building bespoke surrogates is both fun and challenging.
To cater a non-technical audience, FAT Forensics implements pre-made surrogates
in addition to implementing their core building blocks.
At the moment, two such explainers are available.</p>
<section id="tabularblimeylime">
<h4>TabularBlimeyLime<a class="headerlink" href="#tabularblimeylime" title="Permalink to this headline">¶</a></h4>
<p>This is an implementation of the popular LIME algorithm inside of the
FAT Forensics package.
This algorithm involves discretising the data using
<code class="docutils literal notranslate"><span class="pre">fatf.utils.data.discretisation.QuartileDiscretiser</span></code> and
sampling around a query data point within the discrete representation
with <code class="docutils literal notranslate"><span class="pre">fatf.utils.data.augmentation.NormalSampling</span></code>.
The sampled data is then transformed into a binary interpretable representation
where the interpretable features for the sampled data are 1 if they lie in
the same quartile (or category for categorical attributes) as the query point, else 0.
A weighted ridge regressor is then fitted to the interpretable representation
with the aim of predicting the probabilities of a selected (explained)
class output by the black-box model for the local sample.
The coefficients of this regressor are then used as interpretable
feature importance (explanations).</p>
<p>This implementation is limited to probabilistic black boxes.
For a more in depth description please see the documentation of this class
<a class="reference external" href="https://fat-forensics.org/generated/fatf.transparency.predictions.surrogate_explainers.TabularBlimeyLime.html">here</a>.</p>
</section>
<section id="tabularblimeytree">
<h4>TabularBlimeyTree<a class="headerlink" href="#tabularblimeytree" title="Permalink to this headline">¶</a></h4>
<p>This is a surrogate explainer based on a decision tree.
This explainer does not use an interpretable representation, instead the local
decision tree learns one.
In this case, data augmentation is done with
<code class="docutils literal notranslate"><span class="pre">fatf.utils.data.augmentation.Mixup</span></code> and the data are no discretised beforehand.
Data are augmented around a query point and a regression tree is fitted to the
probabilities of a selected (explained) class output by the black-box model
for the local sample.</p>
<p>At the moment, the only two available explanations are tree-based feature
importance and tree structure visualisation; counterfactuals and rules are
coming soon.
For a more in depth description please see the documentation for this class
<a class="reference external" href="https://fat-forensics.org/generated/fatf.transparency.predictions.surrogate_explainers.TabularBlimeyTree.html">here</a>.</p>
</section>
</section>
<section id="final-remarks">
<h3>Final Remarks<a class="headerlink" href="#final-remarks" title="Permalink to this headline">¶</a></h3>
<p>We’ve covered quite a lot of ground.
While the steps required to extract visually appealing explanations from
local surrogates may have been complicated, we are currently developing
relevant algorithms within the FAT Forensics package to address this issue.
In particular, we are implementing more streamlined explanatory mechanisms
for scikit-learn decision trees.</p>
<p>You may have hoped for a secret recipe for building surrogates – we’re sorry
to disappoint you.
There is no single magical combination – a silver bullet – and you simply
need to adapt the composition of your surrogate explainer to the problem at
hand.
However, there are some general rules.
For example, when sampling in the binary or discrete interpretable domains,
the augmented data will be <strong>global</strong> and not local.
In such a case, instance weighting based on kernelised distances is
<strong>strongly recommend</strong>, but then you need to choose the distance metric,
kernel and its parameterisation.
With an inherently local sample, the latter step is not required but may be
helpful.
Another example is tree-specific: it may be desirable to overfit the local
surrogate tree to the data sampled in the explained neighbourhood
(vicinity of the explained instance)
to achieve an arbitrarily good fidelity with respect to our sample.
All in all, you need to choose wisely.</p>
<p>Now, if you choose to do so, it is time for you to build your own bespoke
surrogate explainer.
A more concise story of building custom surrogate explainers of tabular data
is available as a how-to guide on FAT Forensics’ website
<a class="reference external" href="https://fat-forensics.org/how_to/transparency/tabular-surrogates.html">here</a>.
Most of the code from this guide has been ported into the
<code class="docutils literal notranslate"><span class="pre">0-environment-test.ipynb</span></code> notebook, which we used at the beginning to test
the environment.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./book/meta_explainers/surrogates"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="data_sampling.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title"><span class="section-number">1.2. </span>Data Sampling</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="examples.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">1.4. </span>Interactive Examples</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By <a href="mailto:kacper@xmlx.io">Kacper Sokol</a> and <a href="mailto:team@xmlx.io">XMLX Team</a> – <a href="https://xmlx.io/">xmlx.io</a>.<br> Distributed under <a href="https://github.com/xmlx-io/xml-book/blob/master/LICENCE">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International Licence</a>.
<br/>
    
        &copy; Copyright 2021–2022.<br/>
      <div class="extra_footer">
        <p> This book delivers a comprehensive outlook on the most popular explainability concepts in Machine Learning. It covers a range of theoretical and practical topics across different difficulty levels, including but not limited to: high-level overviews & introductory examples; mathematical foundations; algorithmic implementations; practical advice & real-life caveats; and success & failure case studies. </p>

      </div>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>